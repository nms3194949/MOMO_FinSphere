<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘æˆ°æƒ…å®¤ V43 (Fix)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #0f172a; 
            --card-bg: #1e293b; 
            --modal-bg: #1e293b;
            --text: #f1f5f9; 
            --red: #ef4444; 
            --yellow: #eab308; 
            --green: #10b981; 
            --blue: #3b82f6;
            --purple: #a855f7;
            --orange: #f97316;
            --gray: #64748b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 15px; margin: 0; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { text-align: center; font-weight: 800; margin-bottom: 5px; background: linear-gradient(to right, #60a5fa, #a78bfa); -webkit-background-clip: text; color: transparent; font-size: 1.8rem; letter-spacing: -0.5px; }
        .subtitle { text-align: center; color: #94a3b8; font-size: 0.85rem; margin-bottom: 20px; font-weight: 500;}

        /* ç‹€æ…‹åˆ— */
        .status-bar { text-align: center; font-size: 0.8rem; color: #64748b; margin-bottom: 15px; min-height: 20px;}

        /* ç¯©é¸æŒ‰éˆ•åˆ— (Sticky) */
        .filter-wrapper { position: sticky; top: 0; background: var(--bg); z-index: 10; padding: 10px 0; margin: 0 -15px; padding-left: 15px; }
        .filter-container { display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding-right: 15px; }
        .filter-container::-webkit-scrollbar { display: none; }
        
        .filter-btn { 
            background: rgba(30, 41, 59, 0.8); color: #94a3b8; border: 1px solid #334155; backdrop-filter: blur(4px);
            padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; font-weight: 500;
        }
        .filter-btn.active { background: var(--blue); color: white; border-color: var(--blue); font-weight: bold; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); transform: translateY(-1px); }
        .filter-btn:active { transform: scale(0.95); }

        /* ç¶²æ ¼èˆ‡å¡ç‰‡ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; padding-top: 5px; }
        
        .fund-card { 
            background: var(--card-bg); border-radius: 16px; padding: 18px; 
            border: 1px solid #334155; position: relative; transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column; gap: 12px; cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fund-card:active { transform: scale(0.98); }
        
        /* ç‡ˆè™Ÿç‰¹æ•ˆ */
        .status-buy { border-left: 4px solid var(--red); background: linear-gradient(135deg, rgba(239,68,68,0.05) 0%, var(--card-bg) 100%); } 
        .status-watch { border-left: 4px solid var(--yellow); } 
        .status-safe { border-left: 4px solid var(--green); opacity: 0.85; } 

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; }
        .fund-name { font-weight: 700; font-size: 1.05rem; line-height: 1.4; color: #e2e8f0; flex: 1; margin-right: 4px; }
        .card-top-right { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .strategy-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 6px; background: rgba(0,0,0,0.2); font-weight: 600; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }

        /* è¶¨å‹¢å¾½ç«  */
        .trend-badge {
            font-size: 0.7rem;
            padding: 2px 7px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.6);
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        .trend-dot {
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: #9ca3af;
        }
        .trend-bull     { border-color: #22c55e; color:#bbf7d0; }
        .trend-bull .trend-dot { background:#22c55e; }
        .trend-bear     { border-color: #ef4444; color:#fecaca; }
        .trend-bear .trend-dot { background:#ef4444; }
        .trend-neutral { border-color: #eab308; color:#facc15; }
        .trend-neutral .trend-dot { background:#eab308; }

        /* ç¼ºæ¼è³‡æ–™è­¦ç¤º ICON */
        .data-warning {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            font-size: 0.85rem;
            color: #fbbf24;
        }

        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .data-item { display: flex; flex-direction: column; }
        .lbl { font-size: 0.75rem; color: #94a3b8; margin-bottom: 2px; letter-spacing: 0.5px; }
        .val { font-size: 1.2rem; font-weight: 700; font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
        .dd-val.alert { color: var(--red); text-shadow: 0 0 10px rgba(239, 68, 68, 0.3); }
        .dd-val.warn { color: var(--yellow); }

        .target-bar { background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px 12px; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .gap-close { color: var(--red); font-weight: bold; animation: pulse 2s infinite; }
        .gap-far { color: var(--green); font-weight: 500; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .chart-container { height: 60px; width: 100%; pointer-events: none; }

        /* æ‡¸æµ®æŒ‰éˆ• */
        .fab-container { position: fixed; bottom: 25px; right: 25px; display: flex; flex-direction: column; gap: 15px; z-index: 90; }
        .fab { 
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.4rem; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); border: none; color: white; transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }
        .fab-refresh { background: var(--blue); }
        .fab-update { background: var(--red); }

        #loading { text-align: center; margin-top: 50px; color: #94a3b8; display: none; }
        .empty-state { grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b; background: rgba(255,255,255,0.02); border-radius: 12px; border: 2px dashed #334155; }

        /* é€šç”¨ Modal æ¨£å¼ */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px);
            z-index: 100; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-backdrop.show { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: var(--modal-bg); width: 90%; max-width: 600px; max-height: 90vh;
            border-radius: 20px; padding: 20px; border: 1px solid #475569;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; overflow-y: auto; transform: translateY(20px); transition: transform 0.3s ease;
        }
        .modal-backdrop.show .modal-content { transform: translateY(0); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--text); display:flex; align-items:center; gap:6px; }
        .btn-close { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 5px; }
        
        /* è©³æƒ…è¦–çª—æ¨£å¼ */
        .big-chart-box { height: 300px; width: 100%; margin-bottom: 20px; }
        .modal-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .modal-info-item { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px; text-align: center; }
        .modal-lbl { font-size: 0.8rem; color: #94a3b8; display: block; margin-bottom: 5px; }
        .modal-val { font-size: 1.1rem; font-weight: bold; font-family: 'Roboto Mono'; }
        .modal-desc { font-size: 0.85rem; color: #94a3b8; line-height: 1.6; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; border-left: 3px solid var(--blue); }

        /* æ›´æ–°å ±å‘Šæ¨£å¼ */
        .result-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .r-name { font-weight: bold; color: #e2e8f0; font-size: 0.95rem; }
        .r-info { text-align: right; }
        .r-date { font-size: 0.75rem; color: #94a3b8; display: block; }
        .r-nav { font-family: 'Roboto Mono'; font-weight: bold; color: var(--green); font-size: 1rem; }

    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¯ åŸºé‡‘æˆ°æƒ…å®¤ <span style="font-size:0.5em; vertical-align:middle; opacity:0.7; background:#334155; padding:2px 6px; border-radius:4px;">V43 Fix</span></h1>
    <p class="subtitle">é›™æ ¸ç­–ç•¥ç›£æ§ â€¢ æ™ºèƒ½è©³æƒ…åˆ†æ</p>

    <div id="status-display" class="status-bar"></div>

    <div class="filter-wrapper">
        <div class="filter-container">
            <button class="filter-btn active" onclick="setFilter('ALL')">å…¨éƒ¨</button>
            <button class="filter-btn" onclick="setFilter('SIGNAL')" style="color:#f87171; border-color:#ef4444">ğŸš¨ è¨Šè™Ÿå€</button>
            <button class="filter-btn" onclick="setFilter('BOND')">ğŸŸ¦ å‚µåˆ¸ (ä¹–é›¢)</button>
            <button class="filter-btn" onclick="setFilter('EQUITY')">ğŸŸ§ è‚¡ç¥¨ (å›æ’¤)</button>
            <button class="filter-btn" onclick="setFilter('BALANCED')">ğŸŸª å¹³è¡¡</button>
        </div>
    </div>

    <div id="loading">ğŸ“¡ æ­£åœ¨é€£ç·šè³‡æ–™åº«...</div>
    <div id="dashboard" class="grid"></div>
</div>

<div class="fab-container">
    <button class="fab fab-update" onclick="manualUpdate()" title="è§¸ç™¼å¾Œç«¯æ›´æ–°">ğŸš€</button>
    <button class="fab fab-refresh" onclick="forceReload()" title="å¼·åˆ¶åˆ·æ–°">â†»</button>
</div>

<div id="detail-modal" class="modal-backdrop" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <div class="modal-title" id="m-title">åŸºé‡‘åç¨±</div>
            <button class="btn-close" onclick="closeModal()">Ã—</button>
        </div>
        <div class="modal-info" id="m-info-box"></div>
        <div class="big-chart-box">
            <canvas id="big-chart"></canvas>
        </div>
        <div class="modal-desc" id="m-strategy-desc">ç­–ç•¥èªªæ˜...</div>
    </div>
</div>

<div id="update-result-modal" class="modal-backdrop" onclick="closeUpdateModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-height: 80vh;">
        <div class="modal-header">
            <div class="modal-title">ğŸš€ æ›´æ–°çµæœå ±å‘Š</div>
            <button class="btn-close" onclick="closeUpdateModal()">Ã—</button>
        </div>
        <div style="padding: 10px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; margin-bottom: 15px; color: #10b981; font-size: 0.9rem;" id="update-msg">
            ç‹€æ…‹è¨Šæ¯...
        </div>
        <div class="result-list" id="update-list" style="display: flex; flex-direction: column; gap: 8px; overflow-y: auto;">
            </div>
        <button onclick="closeUpdateModal()" style="margin-top:20px; width:100%; padding:12px; background:var(--blue); color:white; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">ç¢ºèªä¸¦åˆ·æ–°</button>
    </div>
</div>

<script>
    // â–¼â–¼â–¼ Google Apps Script ç¶²å€ (è«‹ç¢ºèªæ˜¯å¦éœ€è¦æ›´æ–°) â–¼â–¼â–¼
    const API_URL = "https://script.google.com/macros/s/AKfycbwYVirIuGO475Kb63z4jTKKgSPINSqy9jM3wPaQPMfa0DXzpdDybCXpoiqfPmeveb7F0g/exec"; 
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const MA_DAYS = 240; 
    const MA_SHORT_DAYS = 60;
    
    // ğŸ”¥ ã€é—œéµä¿®æ”¹ã€‘ æ›´æ–° Cache Keyï¼Œå¼·åˆ¶ç€è¦½å™¨æ¨æ£„èˆŠçš„éŒ¯èª¤è³‡æ–™
    const CACHE_KEY = 'fund_radar_v43_fix_data'; 
    
    let globalFunds = [];
    let currentFilter = 'ALL';
    let bigChartInstance = null; 

    const STRATEGIES = {
        BOND: { name: "å‚µåˆ¸é ˜æ¯", color: "#3b82f6", type: "BOND", useBias: true, watch: -0.04, buy: -0.07, desc: "å‚µåˆ¸çœ‹ã€Œå¹´ç·šä¹–é›¢ã€ã€‚ç•¶åƒ¹æ ¼è·Œç ´å¹´ç·šä¸€å®šå¹…åº¦ï¼Œé€šå¸¸æ˜¯è¶…è·Œï¼Œé©åˆé ˜æ¯æ—é€²å ´ã€‚" },
        BALANCED: { name: "å¹³è¡¡ç©©å¥", color: "#a855f7", type: "BALANCED", useBias: false, watch: -0.08, buy: -0.15, desc: "å¹³è¡¡å‹æ³¢å‹•é©ä¸­ï¼Œæ¡ç”¨ã€Œæ³¢æ®µå›æ’¤ã€ç­–ç•¥ï¼ŒæŠ“ä¸­å‹ä¿®æ­£æ³¢æ®µã€‚" },
        EQUITY: { name: "è‚¡ç¥¨ç©æ¥µ", color: "#f97316", type: "EQUITY", useBias: false, watch: -0.15, buy: -0.25, desc: "è‚¡ç¥¨å‹æ³¢å‹•å¤§ï¼Œéœ€ç­‰å¾…ã€Œå¤§å¹…å›æ’¤ã€è‡³ææ…Œå€é–“å†å‡ºæ‰‹ï¼Œé¿å…æ¥åˆ€ã€‚" }
    };

    async function init() {
        const dashboard = document.getElementById('dashboard');
        const loading = document.getElementById('loading');
        const statusDisplay = document.getElementById('status-display');

        const cached = localStorage.getItem(CACHE_KEY);
        let hasCache = false;
        
        if (cached) {
            try {
                const json = JSON.parse(cached);
                if (json.data && json.timestamp) {
                    processData(json.headers, json.data);
                    renderDashboard();
                    hasCache = true;
                    const minDiff = Math.floor((Date.now() - json.timestamp) / 60000);
                    statusDisplay.innerHTML = `âš¡ å¿«å–è³‡æ–™ (${minDiff}m å‰) â€¢ <span style="animation:pulse 1s infinite; color:var(--blue)">èƒŒæ™¯æ›´æ–°ä¸­...</span>`;
                }
            } catch (e) { console.error("Cache Error", e); }
        }

        if (!hasCache) {
            loading.style.display = 'block';
            statusDisplay.innerText = '';
        }

        try {
            const res = await fetch(`${API_URL}?op=get_db_monitor`);
            const json = await res.json();
            
            if (json.error) throw new Error(json.error);

            json.timestamp = Date.now();
            localStorage.setItem(CACHE_KEY, JSON.stringify(json));

            processData(json.headers, json.data);
            renderDashboard();
            
            loading.style.display = 'none';
            statusDisplay.innerHTML = `âœ… è³‡æ–™å·²æ›´æ–° â€¢ ${new Date().toLocaleTimeString()}`;

        } catch (err) {
            loading.style.display = 'none';
            if (!hasCache) {
                dashboard.innerHTML = `<div class="empty-state">âŒ é€£ç·šå¤±æ•—: ${err.message}</div>`;
            } else {
                statusDisplay.innerHTML = `âš ï¸ æ›´æ–°å¤±æ•— (é¡¯ç¤ºèˆŠè³‡æ–™) â€¢ ${err.message}`;
            }
        }
    }

    function processData(headers, rows) {
        // rows: [ [date, f1, f2, ...], ... ]  (å¾Œç«¯å·²ä¿è­‰çµ¦æ–°çš„ï¼Œä½†æˆ‘å€‘é‚„æ˜¯é˜²å‘†è™•ç†ä¸€ä¸‹)
        let cleanRows = rows.map(row => {
            let ts = Date.parse(row[0]);
            return isNaN(ts) ? null : { ts: ts, date: row[0], data: row };
        }).filter(r => r).sort((a, b) => a.ts - b.ts); // ğŸ”¥ é€™è£¡ä¿è­‰è³‡æ–™ç”±èˆŠåˆ°æ–°æ’åºï¼Œæ–¹ä¾¿è¨ˆç®— MA

        let tempFunds = [];

        for (let i = 1; i < headers.length; i++) {
            let name = headers[i];
            if(name.includes("006208") || name.includes("SPY")) continue; 

            let history = [];
            let maxNav = 0;
            let lastDate = null;

            cleanRows.forEach(item => {
                let val = parseFloat(item.data[i]);
                if (!isNaN(val)) {
                    history.push(val);
                    if (val > maxNav) maxNav = val;
                    lastDate = item.date;
                }
            });

            if (history.length > 0) {
                let currentNav = history[history.length - 1];
                let dd = (currentNav - maxNav) / maxNav;

                // 240MA èˆ‡ä¹–é›¢
                let maSeries = [];
                for(let k=0; k<history.length; k++) {
                    if(k < MA_DAYS - 1) {
                        maSeries.push(null);
                    } else {
                        let sum = 0;
                        for(let m=0; m<MA_DAYS; m++) sum += history[k-m];
                        maSeries.push(sum / MA_DAYS);
                    }
                }
                
                let maValue = null, bias = null;
                if (history.length >= MA_DAYS) {
                    maValue = maSeries[maSeries.length-1];
                    bias = (currentNav - maValue) / maValue;
                } else { bias = 0; }

                // 60 æ—¥ MA èˆ‡çŸ­æœŸ MA / LONG MA for è¶¨å‹¢åˆ¤æ–·
                let ma60Series = [];
                for(let k=0; k<history.length; k++) {
                    if(k < MA_SHORT_DAYS - 1) {
                        ma60Series.push(null);
                    } else {
                        let sum = 0;
                        for(let m=0; m<MA_SHORT_DAYS; m++) sum += history[k-m];
                        ma60Series.push(sum / MA_SHORT_DAYS);
                    }
                }

                let maShort = null;
                if (history.length >= 5) {
                    let win = Math.min(MA_SHORT_DAYS, history.length);
                    let sum = 0;
                    for(let idx = history.length - win; idx < history.length; idx++) sum += history[idx];
                    maShort = sum / win;
                }
                let maLong = (history.length >= MA_DAYS && maSeries[maSeries.length-1]) ? maSeries[maSeries.length-1] : null;

                let trendLabel = "ä¸­æ€§";
                let trendClass = "trend-neutral";
                if (maShort && maLong) {
                    let diff = (maShort - maLong) / maLong;
                    if (diff >= 0.02) {
                        trendLabel = "å¤šé ­";
                        trendClass = "trend-bull";
                    } else if (diff <= -0.02) {
                        trendLabel = "ç©ºé ­";
                        trendClass = "trend-bear";
                    }
                }

                // è³‡æ–™ç¼ºæ¼åµæ¸¬ï¼šæ­·å²é»å¤ªå°‘ æˆ– è¶…é 7 å¤©æ²’æ–° NAV
                let hasDataIssue = false;
                let diffDays = null;
                if (lastDate) {
                    let lastDateObj = new Date(lastDate.replace(/-/g,"/"));
                    let today = new Date();
                    diffDays = Math.floor((today - lastDateObj) / (1000*60*60*24));
                    if (diffDays > 7) hasDataIssue = true;
                }
                if (history.length < 10) hasDataIssue = true;

                // ç­–ç•¥åˆ†é¡
                let strategy = STRATEGIES.EQUITY;
                if (name.includes("å‚µ") || name.includes("æˆ¿è²¸") || name.includes("æ”¶ç›Š")) strategy = STRATEGIES.BOND;
                else if (name.includes("å¤šé‡") || name.includes("å¹³è¡¡")) strategy = STRATEGIES.BALANCED;

                let gap = 0, monitorValue = 0;
                if (strategy.useBias) {
                    monitorValue = bias;
                    gap = bias - strategy.buy; 
                } else {
                    monitorValue = dd;
                    gap = dd - strategy.buy;
                }

                tempFunds.push({
                    name, 
                    nav: currentNav, 
                    high: maxNav, 
                    dd, 
                    bias, 
                    monitorValue, 
                    strategy, 
                    history: history, 
                    maSeries: maSeries,         // 240MA
                    ma60Series: ma60Series,     // 60MA
                    gap: gap,
                    maShort,
                    maLong,
                    trendLabel,
                    trendClass,
                    hasDataIssue,
                    lastDate,
                    diffDays
                });
            }
        }
        tempFunds.sort((a, b) => a.gap - b.gap);
        globalFunds = tempFunds;
    }

    function setFilter(type) {
        currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderDashboard();
    }

    function renderDashboard() {
        const dashboard = document.getElementById('dashboard');
        dashboard.innerHTML = '';

        let displayFunds = globalFunds.filter(f => {
            if (currentFilter === 'ALL') return true;
            if (currentFilter === 'SIGNAL') return f.monitorValue <= f.strategy.watch;
            return f.strategy.type === currentFilter;
        });

        if (displayFunds.length === 0) {
            dashboard.innerHTML = `<div class="empty-state">ğŸ“­ æ­¤åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</div>`;
            return;
        }

        displayFunds.forEach((f) => createCard(dashboard, f));
    }

    function createCard(container, f) {
        let ddPct = (f.dd * 100).toFixed(1) + '%';
        let biasPct = f.bias !== null ? (f.bias * 100).toFixed(1) + '%' : 'N/A';
        
        let mainLabel = f.strategy.useBias ? "å¹´ç·šä¹–é›¢" : "æ³¢æ®µå›æ’¤";
        let mainValText = f.strategy.useBias ? biasPct : ddPct;
        
        let targetLabel = f.strategy.useBias ? "ç›®æ¨™ä¹–é›¢" : "ç›®æ¨™å›æ’¤";
        let targetVal = (f.strategy.buy * 100).toFixed(0) + '%';
        
        let statusClass = 'status-safe';
        let msg = `è·é›¢ ${Math.abs(f.gap * 100).toFixed(1)}%`;
        let gapClass = 'gap-far';

        if (f.monitorValue <= f.strategy.buy) {
            statusClass = 'status-buy';
            msg = `ğŸš¨ å·²é”æ¨™ï¼`;
            gapClass = 'gap-close';
        } else if (f.monitorValue <= f.strategy.watch) {
            statusClass = 'status-watch';
            msg = `âš ï¸ è§€å¯Ÿä¸­`;
            gapClass = 'gap-close';
        }

        let card = document.createElement('div');
        card.className = `fund-card ${statusClass}`;
        card.onclick = () => openModal(f);

        let miniChartId = 'chart-' + Math.random().toString(36).substr(2, 9);
        let miniHistory = f.history.slice(-60);

        const trendText = f.trendLabel || 'â€”';
        const trendClass = f.trendClass || 'trend-neutral';

        let warningIcon = '';
        if (f.hasDataIssue) {
            warningIcon = `<span class="data-warning" title="è³‡æ–™å¯èƒ½æœ‰ç¼ºæ¼æˆ–è¶…é 7 å¤©æœªæ›´æ–°">âš </span>`;
        }

        card.innerHTML = `
            <div class="card-top">
                <div class="fund-name">${f.name}${warningIcon}</div>
                <div class="card-top-right">
                    <div class="strategy-tag" style="color:${f.strategy.color}; border-color:${f.strategy.color}">
                        ${f.strategy.name}
                    </div>
                    <div class="trend-badge ${trendClass}">
                        <span class="trend-dot"></span>
                        <span>${trendText}</span>
                    </div>
                </div>
            </div>
            
            <div class="data-grid">
                <div class="data-item">
                    <span class="lbl" style="color:${f.strategy.color}">${mainLabel}</span>
                    <span class="val dd-val ${f.monitorValue <= f.strategy.watch ? 'warn' : ''} ${f.monitorValue <= f.strategy.buy ? 'alert' : ''}">${mainValText}</span>
                </div>
                <div class="data-item" style="align-items:flex-end">
                    <span class="lbl">æœ€æ–°æ·¨å€¼</span>
                    <span class="val" style="font-size:1.1rem; color:#fff">$${f.nav}</span>
                </div>
            </div>

            <div class="target-bar">
                <span style="color:#94a3b8; font-size:0.8rem">${targetLabel}: <b style="color:${f.strategy.color}">${targetVal}</b></span>
                <span class="${gapClass}">${msg}</span>
            </div>

            <div class="chart-container">
                <canvas id="${miniChartId}"></canvas>
            </div>
        `;
        container.appendChild(card);
        drawMiniChart(miniChartId, miniHistory, f.strategy.color, f.monitorValue <= f.strategy.watch);
    }

    function drawMiniChart(id, data, color, isAlert) {
        const ctx = document.getElementById(id).getContext('2d');
        let lineColor = isAlert ? '#ef4444' : color;
        let lineWidth = isAlert ? 2.5 : 2;
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map((_, i) => i),
                datasets: [{ data: data, borderColor: lineColor, borderWidth: lineWidth, pointRadius: 0, fill: false, tension: 0.3 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, animation: false,
                plugins: { legend: { display: false }, tooltip: { enabled: false } },
                scales: { x: { display: false }, y: { display: false } },
                layout: { padding: 5 }
            }
        });
    }

    // Modal Functions
    function openModal(f) {
        const modal = document.getElementById('detail-modal');

        let warningIcon = '';
        if (f.hasDataIssue) {
            warningIcon = `<span class="data-warning" title="è³‡æ–™å¯èƒ½æœ‰ç¼ºæ¼æˆ–è¶…é 7 å¤©æœªæ›´æ–°">âš </span>`;
        }

        document.getElementById('m-title').innerHTML = `${f.name}${warningIcon ? ' ' + warningIcon : ''}`;
        document.getElementById('m-strategy-desc').innerText = `ğŸ’¡ ${f.strategy.desc} \nç›®å‰è¨­å®šè²·é»ï¼š${(f.strategy.buy*100).toFixed(0)}%`;

        let ddPct = (f.dd * 100).toFixed(2) + '%';
        let biasPct = f.bias !== null ? (f.bias * 100).toFixed(2) + '%' : '-';

        let trendText = f.trendLabel || 'ä¸­æ€§';
        let trendColor = '#fde68a';
        if (f.trendClass === 'trend-bull') trendColor = '#bbf7d0';
        if (f.trendClass === 'trend-bear') trendColor = '#fecaca';

        let infoHtml = `
            <div class="modal-info-item">
                <span class="modal-lbl">æœ€æ–°æ·¨å€¼</span>
                <span class="modal-val" style="color:white">$${f.nav}</span>
            </div>
            <div class="modal-info-item">
                <span class="modal-lbl">å¹´ç·šä¹–é›¢</span>
                <span class="modal-val" style="color:${f.strategy.useBias?f.strategy.color:''}">${biasPct}</span>
            </div>
            <div class="modal-info-item">
                <span class="modal-lbl">æ³¢æ®µå›æ’¤</span>
                <span class="modal-val" style="color:${!f.strategy.useBias?f.strategy.color:''}">${ddPct}</span>
            </div>
            <div class="modal-info-item">
                <span class="modal-lbl">è¶¨å‹¢(60 vs 240)</span>
                <span class="modal-val" style="color:${trendColor}">${trendText}</span>
            </div>
        `;
        document.getElementById('m-info-box').innerHTML = infoHtml;
        drawBigChart(f);
        modal.classList.add('show');
    }

    function closeModal(e) {
        if(e && e.target !== document.getElementById('detail-modal') && e.target.className !== 'btn-close') return;
        document.getElementById('detail-modal').classList.remove('show');
    }

    function drawBigChart(f) {
        const ctx = document.getElementById('big-chart').getContext('2d');
        if(bigChartInstance) bigChartInstance.destroy();

        let days = 250;
        let startIdx = Math.max(0, f.history.length - days);
        let prices = f.history.slice(startIdx);
        let ma240 = f.maSeries ? f.maSeries.slice(startIdx) : [];
        let ma60  = f.ma60Series ? f.ma60Series.slice(startIdx) : [];
        let labels = prices.map((_,i) => i);

        let datasets = [{
            label: 'æ·¨å€¼',
            data: prices,
            borderColor: '#e2e8f0',
            borderWidth: 2,
            pointRadius: 0,
            tension: 0.1
        }];

        // 60 æ—¥å‡ç·š
        if (ma60.some(v => v !== null)) {
            datasets.push({
                label: '60 æ—¥å‡ç·š',
                data: ma60,
                borderColor: '#60a5fa',
                borderWidth: 1.5,
                pointRadius: 0,
                tension: 0.1
            });
        }

        // 240 æ—¥å‡ç·š
        if (ma240.some(v => v !== null)) {
            datasets.push({
                label: '240 æ—¥å‡ç·š',
                data: ma240,
                borderColor: '#eab308',
                borderWidth: 1.2,
                borderDash: [5,5],
                pointRadius: 0,
                tension: 0.1
            });
        }

        if(f.strategy.useBias) {
            // å‚µåˆ¸ï¼šå¹´ç·š + è²·é»ç·š
            let buyTargetLine = ma240.map(v => v ? v * (1 + f.strategy.buy) : null);
            datasets.push({
                label: `è²·é» (${(f.strategy.buy*100).toFixed(0)}%)`,
                data: buyTargetLine,
                borderColor: '#10b981',
                borderWidth: 1,
                pointRadius: 0
            });
        } else {
            // è‚¡ç¥¨/å¹³è¡¡ï¼šä»¥å…¨æœŸé«˜é»è¨ˆç®—çš„ç›®æ¨™åƒ¹
            let buyTargetLine = prices.map(p => f.high * (1 + f.strategy.buy));
            datasets.push({
                label: `ç›®æ¨™åƒ¹ (${(f.strategy.buy*100).toFixed(0)}%)`,
                data: buyTargetLine,
                borderColor: '#10b981',
                borderWidth: 1,
                borderDash: [5, 5],
                pointRadius: 0
            });
        }

        bigChartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { 
                    legend: { labels: { color: '#94a3b8' } }, 
                    tooltip: { mode: 'index', intersect: false } 
                },
                scales: { 
                    x: { display: false }, 
                    y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } } 
                }
            }
        });
    }

    // æ›´æ–°çµæœ Modal Functions
    function closeUpdateModal(e) {
        if(e && e.target !== document.getElementById('update-result-modal') && e.target.className !== 'btn-close') return;
        document.getElementById('update-result-modal').classList.remove('show');
        forceReload(); 
    }

    function showUpdateResults(msg, details) {
        const modal = document.getElementById('update-result-modal');
        const listContainer = document.getElementById('update-list');
        const msgBox = document.getElementById('update-msg');

        msgBox.innerText = msg;
        listContainer.innerHTML = '';

        if (!details || details.length === 0) {
            listContainer.innerHTML = '<div style="text-align:center; color:#64748b; padding:20px;">æœ¬æ¬¡æ²’æœ‰æ“·å–åˆ°æ–°è³‡æ–™</div>';
        } else {
            details.forEach(item => {
                let div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <div class="r-name">${item.name}</div>
                    <div class="r-info">
                        <span class="r-nav">$${item.nav}</span>
                        <span class="r-date">${item.date}</span>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }
        modal.classList.add('show');
    }

    async function manualUpdate() {
        if(!confirm("âš ï¸ ç¢ºå®šè¦æ‰‹å‹•è§¸ç™¼å¾Œç«¯æ›´æ–°å—ï¼Ÿ\n\né€™æœƒå«å–š Google çˆ¬èŸ²å»æŠ“å–æœ€æ–°è‚¡åƒ¹ï¼Œéç¨‹ç´„éœ€ 15~30 ç§’ã€‚")) return;

        const loading = document.getElementById('loading');
        const updateBtn = document.querySelector('.fab-update');
        
        loading.style.display = 'block';
        loading.innerHTML = `<div style="font-size: 1.2rem;">ğŸ“¡ æ­£åœ¨é€£ç·šçˆ¬èŸ²...</div><div style="font-size:0.9rem; color:#94a3b8">è«‹ç¨å€™ï¼Œæ­£åœ¨æ”¶é›†æœ€æ–°æ·¨å€¼</div>`;
        
        if(updateBtn) { updateBtn.style.opacity = "0.5"; updateBtn.style.pointerEvents = "none"; }

        try {
            const res = await fetch(`${API_URL}?op=manual_update`);
            const json = await res.json();
            loading.style.display = 'none';

            if (json.status === "success") {
                showUpdateResults(json.message, json.details);
            } else {
                throw new Error(json.message || "æœªçŸ¥éŒ¯èª¤");
            }

        } catch (err) {
            loading.style.display = 'none';
            alert(`âŒ æ›´æ–°å¤±æ•—ï¼š\n${err.message}`);
        } finally {
            if(updateBtn) { updateBtn.style.opacity = "1"; updateBtn.style.pointerEvents = "auto"; }
        }
    }

    function forceReload() {
        localStorage.removeItem(CACHE_KEY); 
        init();
    }

    init();
</script>

</body>
</html>
