<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>MOMO FinSphereï½œGoogle Sheet å°ˆæ¥­ç‰ˆï¼ˆå…¨è‡ªå‹•é‹ç®—ç‰ˆï¼‰</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{
      --deep:#0A1221; --ink:#EDEFF5; --muted:#94A3B8;
      --gold-strong:#F9E27C; --gold-mid:#D9B84B; --gold:#C9A227; --gold-soft:#E9D18A;
      --gold-grad:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%);
      --accent-blue:#38BDF8; --accent-green:#34D399;
      --panel: rgba(255,255,255,.03); --line:rgba(233,209,138,.12);
    }
    *{box-sizing:border-box;font-family:'Noto Sans TC',sans-serif;}
    body{background:var(--deep);color:var(--ink);margin:0;padding:20px;}

    #report-capture{
      max-width:1180px;margin:0 auto;background:var(--deep);padding:34px;
      border-radius:30px;position:relative;border:1px solid var(--line);overflow:hidden;
    }
    .watermark{
      position:absolute;top:14px;left:0;right:0;text-align:center;
      font-size:12px;color:rgba(255,255,255,.10);font-weight:900;letter-spacing:3px;
      pointer-events:none;
    }

    header{padding-bottom:18px;margin-bottom:18px;}
    .header-row{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
    .title-wrap h1{margin:0;font-size:28px;background:var(--gold-grad);-webkit-background-clip:text;color:transparent;}
    .title-wrap p{margin:6px 0 0 0;color:#8aa0b8;font-size:12px;letter-spacing:.3px;}

    .contact-card{
      display:flex;align-items:center;gap:14px;
      padding:10px 14px;border-radius:18px;
      border:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      min-width: 360px;
      max-width: 100%;
    }
    .avatar-ring{
      width:54px;height:54px;border-radius:50%;
      background:radial-gradient(circle at 30% 20%, rgba(249,226,124,.65), rgba(201,162,39,.10));
      padding:2px; border:1px solid rgba(249,226,124,.35); flex:0 0 auto;
    }
    .avatar-ring img{
      width:100%;height:100%;border-radius:50%;object-fit:cover;
      border:1px solid rgba(0,0,0,.35); display:block;
      background:#0b1426;
    }
    .qrbox{padding:6px;background:#fff;border-radius:10px;flex:0 0 auto;}
    .contact-text .t1{font-size:12px;color:#cfe2ff;font-weight:800;margin-bottom:2px;}
    .contact-text .t2{font-size:18px;font-weight:900;color:var(--gold-strong);letter-spacing:.5px;white-space:nowrap;}
    .contact-text .t2 span{color:#fff;font-weight:900;margin-left:6px;}
    .contact-text .hint{font-size:10px;color:#6f859e;margin-top:2px;}

    .layout{display:grid;grid-template-columns:340px 1fr;gap:22px;align-items:start;}
    @media (max-width:1100px){ .layout{grid-template-columns:1fr;} }

    .control-panel{background:var(--panel);padding:18px;border-radius:20px;border:1px solid var(--line);}
    .input-group{margin-bottom:14px;}
    label{display:block;font-size:12px;color:var(--gold-mid);margin-bottom:6px;font-weight:800;}
    input[type="number"], input[type="text"], select{
      width:100%;background:#000;border:1px solid var(--line);
      border-radius:10px;padding:10px 12px;color:#fff;outline:none;transition:0.3s;font-weight:800;
    }
    input:focus, select:focus{border-color:var(--gold);}
    input[type="range"]{width:100%;}

    .gs-box {
      background:rgba(0,0,0,0.3); padding:12px; border-radius:12px; margin-bottom:14px;
      border:1px solid rgba(255,255,255,0.1);
    }
    .btn-action {
      width:100%; padding:10px; border-radius:10px; border:none; cursor:pointer; font-weight:900; margin-top:6px;
      transition:0.2s; color:#0A1221;
    }
    .btn-load { background:#34D399; } .btn-load:hover { background:#6ee7b7; }
    .btn-refresh { background:var(--accent-blue); margin-top:10px; } .btn-refresh:hover { background:#7dd3fc; }

    #load-status{
      margin-top:8px;
      font-size:10px;
      color:#93a4b7;
      line-height:1.35;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.22);
    }
    #load-status b{color:#e9f2ff;}

    .fund-filter{
      width:100%; margin-top:8px;
      font-size:12px; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background:#000; color:#fff; font-weight:800; outline:none;
    }
    .fund-filter::placeholder{color:#64748b; font-weight:800;}

    .selector-tools{
      display:flex; gap:8px; margin:10px 0 10px 0; flex-wrap:wrap;
    }
    .tool-btn{
      flex:1 1 auto;
      padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06); color:#e9f2ff; cursor:pointer;
      font-weight:900; font-size:12px;
      transition:.18s;
    }
    .tool-btn:hover{transform:translateY(-1px); background:rgba(255,255,255,0.09);}
    .tool-btn.danger{border-color:rgba(248,113,113,0.30); color:#fecaca;}
    .tool-btn.gold{border-color:rgba(249,226,124,0.35); color:var(--gold-strong);}
    .tool-btn.blue{border-color:rgba(56,189,248,0.35); color:#bfeaff;}

    .selector-status{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .sum-badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(0,0,0,0.25);
      color:#9fb2c7;font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .toggle-wrap{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:#cfe2ff; font-weight:900; font-size:12px;
      cursor:pointer; user-select:none;
    }
    .toggle-wrap input{ accent-color: var(--gold); transform: scale(1.05); cursor:pointer; }

    .fund-selector-container {
      max-height: 260px; overflow-y: auto; background: #000; border-radius:10px; padding:10px;
      border:1px solid rgba(255,255,255,0.1); margin-bottom: 10px;
    }
    .fund-item {
      display: grid; grid-template-columns: 1fr 46px 46px; align-items: center; gap: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.05); padding: 8px 0; font-size: 11px; color: #ccc;
    }
    .fund-item:last-child { border-bottom: none; }

    .fund-name{
      font-weight:900;
      white-space:normal;
      overflow:hidden;
      display:flex;
      align-items:flex-start;
      gap:8px;
      line-height:1.25;
      padding-left:4px;
      color:#cfe2ff;
    }
    .brand-dot{
      width:10px;height:10px;border-radius:50%;
      margin-top:2px;
      flex:0 0 auto;
      box-shadow: 0 0 0 2px rgba(255,255,255,0.06) inset, 0 0 14px rgba(255,255,255,0.06);
    }
    .brand-text{
      flex:1 1 auto;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
    }

    .chk-col { text-align: center; display: flex; flex-direction: column; align-items: center; }
    input[type="checkbox"] { accent-color: var(--gold); cursor: pointer; transform: scale(1.05); }
    input[type="checkbox"].bench-chk { accent-color: var(--accent-blue); }

    .strat-block{
      border-radius:14px;padding:14px;margin-bottom:14px;
      border-left:4px solid #666;background:rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.06);
    }
    .strat-block.original { border-left-color: var(--accent-blue); }
    .strat-block.momo { border-left-color: var(--gold); }
    .block-header{font-size:13px;font-weight:900;margin-bottom:10px;color:#d7e6ff;}

    .sub-input{
      background:#000;border:1px solid rgba(255,255,255,0.08);
      padding:10px 12px;border-radius:10px;margin-bottom:8px;
    }
    .sub-input label{margin:0 0 4px 0;color:#93a4b7;font-size:10px;}
    .sub-input input{background:transparent;border:none;padding:0;font-size:15px;font-weight:900;color:#fff;width:100%;}
    
    /* è‡ªå‹•è¨ˆç®—æ¨™ç¤º - é‡‘è‰²/è—è‰²æ–‡å­— */
    .strat-block.momo .auto-calced input { color: var(--gold-soft); }
    .strat-block.original .auto-calced input { color: #bfeaff; }

    #dynamic-weights-area, #dynamic-weights-area-bench{
      margin-top:10px; padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:none;
    }

    .weight-row{
      display:grid;
      grid-template-columns: 1fr 74px 42px;
      gap:10px;
      align-items:center;
      margin-bottom:8px;
      font-size:11px;
    }
    .weight-row label{
      margin:0;
      color:#cbd5e1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .weight-input{
      width:74px !important;
      text-align:right;
      background:#000;border:1px solid rgba(255,255,255,0.10);
      border-radius:10px;padding:8px 10px;color:#fff;font-weight:900;
      outline:none;
    }
    .weight-lock{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:#e9f2ff;
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .weight-lock input{ transform: scale(1.05); }
    .lock-hint{
      margin-top:6px;
      font-size:10px;
      color:#667788;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .sum-badge.good{ border-color: rgba(52,211,153,0.25); color:#a7f3d0; }
    .sum-badge.warn{ border-color: rgba(248,113,113,0.25); color:#fecaca; }

    .btn-export-full{
      width:100%;cursor:pointer;border:none;border-radius:12px;
      font-weight:900;padding:14px;background:var(--gold-grad);color:#0A1221;font-size:15px;
      margin-top:10px; transition: transform .15s;
    }
    .btn-export-full:hover{transform:translateY(-1px);}

    .chart-wrapper{
      position:relative;height:520px;width:100%;
      background:rgba(0,0,0,.10); border-radius:18px;
      padding:14px 14px 40px 14px;
      border:1px solid rgba(233,209,138,.10); overflow:hidden;
    }
    @media (max-width:900px){
      .chart-wrapper{height:460px; padding-bottom:44px;}
    }
    @media (max-width:520px){
      .chart-wrapper{height:420px; padding:12px 12px 50px 12px;}
    }

    .chart-title{display:flex;align-items:center;justify-content:space-between;margin:0 0 10px 0;gap:10px;flex-wrap:wrap;}
    .chart-title h4{margin:0;color:#c9d6e6;font-size:14px;font-weight:900;}
    .badge{
      padding:6px 10px;border-radius:999px; background:rgba(249,226,124,.12);
      border:1px solid rgba(249,226,124,.25); color:var(--gold-strong); font-size:12px;font-weight:900;
      white-space:nowrap;
    }
    .chart-canvas-wrap{position:relative;height:100%;width:100%;}

    .bottom-grid{ margin-top:14px; display:grid; grid-template-columns: 1fr; gap:14px; }
    .kpi-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width:980px){ .kpi-row{grid-template-columns: 1fr;} }

    .metric-card{
      border-radius:16px;
      padding:14px 14px 12px 14px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:0 10px 26px rgba(0,0,0,.20);
      min-height: 152px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      position:relative;
      overflow:hidden;
      isolation:isolate;
    }
    .metric-top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      color:#cfe2ff;font-weight:900;font-size:13px;margin-bottom:6px;width:100%;
    }
    .metric-title-group {
      display: flex; align-items: center; gap: 10px;
    }

    .dot{width:12px;height:12px;border-radius:50%;}
    .dot.gold{background:var(--gold-strong);} .dot.blue{background:var(--accent-blue);}
    .dot.lead{background:linear-gradient(180deg, rgba(249,226,124,1), rgba(56,189,248,1));}

    .big{font-size:34px;font-weight:900;color:#fff;letter-spacing:.2px;margin:0 0 6px 0;}
    .sub{font-size:12px;color:#91a3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; line-height:1.4;}
    .sub b{color:#e9f2ff;}

    .pct{
      font-weight:900;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      font-size:11px;
      white-space:nowrap;
    }
    .pct.up{ border-color: rgba(52,211,153,0.25); background: rgba(52,211,153,0.10); color:#a7f3d0; }
    .pct.down{ border-color: rgba(248,113,113,0.25); background: rgba(248,113,113,0.10); color:#fecaca; }

    .lead-topline{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .lead-pct{
      font-size:12px;font-weight:900;
      padding:5px 10px;border-radius:999px;
      border:1px solid rgba(56,189,248,.25);
      background:rgba(56,189,248,.10);
      color:#bfeaff;
      white-space:nowrap;
      position:relative;
      z-index:2;
    }
    .lead-pct.positive{ border-color: rgba(52,211,153,.25); background: rgba(52,211,153,.10); color:#a7f3d0; }
    .lead-pct.negative{ border-color: rgba(248,113,113,.25); background: rgba(248,113,113,.10); color:#fecaca; }

    .lead-card{
      border:1px solid rgba(249,226,124,.26);
      box-shadow:
        0 12px 30px rgba(0,0,0,.25),
        0 0 0 1px rgba(249,226,124,.10) inset;
      background:
        radial-gradient(120% 160% at 15% 20%, rgba(249,226,124,.40), rgba(0,0,0,0) 55%),
        radial-gradient(120% 160% at 90% 10%, rgba(217,184,75,.22), rgba(0,0,0,0) 55%),
        linear-gradient(135deg, rgba(249,226,124,.20), rgba(56,189,248,.08), rgba(185,138,30,.20));
      background-size: 120% 120%;
      animation: leadBreath 3.2s ease-in-out infinite;
    }
    @keyframes leadBreath{
      0%,100%{
        transform: translateY(0);
        box-shadow:
          0 12px 30px rgba(0,0,0,.25),
          0 0 0 1px rgba(249,226,124,.10) inset,
          0 0 22px rgba(249,226,124,.12);
        filter:saturate(1.05);
      }
      50%{
        transform: translateY(-1px);
        box-shadow:
          0 14px 36px rgba(0,0,0,.28),
          0 0 0 1px rgba(249,226,124,.14) inset,
          0 0 34px rgba(249,226,124,.20);
        filter:saturate(1.12);
      }
    }
    .lead-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background: linear-gradient(115deg,
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,.14) 45%,
        rgba(255,255,255,0) 70%
      );
      transform: translateX(-35%) rotate(12deg);
      animation: leadShine 2.8s ease-in-out infinite;
      pointer-events:none;
      z-index:0;
      mix-blend-mode: screen;
      opacity:.8;
    }
    @keyframes leadShine{
      0%{ transform: translateX(-55%) rotate(12deg); opacity:.15; }
      45%{ opacity:.65; }
      100%{ transform: translateX(55%) rotate(12deg); opacity:.15; }
    }
    .lead-card::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 18% 28%, rgba(255,255,255,.20) 0 1.5px, rgba(255,255,255,0) 2px),
        radial-gradient(circle at 34% 62%, rgba(255,255,255,.16) 0 1.2px, rgba(255,255,255,0) 2px),
        radial-gradient(circle at 66% 42%, rgba(255,255,255,.18) 0 1.4px, rgba(255,255,255,0) 2px),
        radial-gradient(circle at 82% 70%, rgba(255,255,255,.14) 0 1.1px, rgba(255,255,255,0) 2px);
      opacity:.35;
      animation: leadSpark 2.4s ease-in-out infinite;
      pointer-events:none;
      z-index:0;
    }
    @keyframes leadSpark{
      0%,100%{ opacity:.18; filter: blur(.1px); }
      50%{ opacity:.42; filter: blur(0px); }
    }
    .lead-card .metric-top, .lead-card .big, .lead-card .sub, .lead-card .lead-pct{
      position:relative;
      z-index:2;
    }

    .div-card{
      min-height: 132px;
      border:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(120% 160% at 15% 20%, rgba(249,226,124,.18), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.22));
    }
    .div-card.blue{
      background:
        radial-gradient(120% 160% at 15% 20%, rgba(56,189,248,.14), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.22));
    }
    .div-amount{
      font-size:36px;
      font-weight:1000;
      letter-spacing:.2px;
      margin:2px 0 6px 0;
      line-height:1.05;
      text-shadow:
        0 0 18px rgba(249,226,124,.22),
        0 0 2px rgba(0,0,0,.45);
    }
    .div-amount.gold{
      background: var(--gold-grad);
      -webkit-background-clip:text;
      color: transparent;
      animation: divGlow 2.6s ease-in-out infinite;
    }
    .div-amount.blu{
      background: linear-gradient(90deg, rgba(56,189,248,1), rgba(207,226,255,1));
      -webkit-background-clip:text;
      color: transparent;
      animation: divGlowBlue 2.8s ease-in-out infinite;
    }
    @keyframes divGlow{
      0%,100%{ filter: drop-shadow(0 0 0 rgba(249,226,124,.0)); transform: translateY(0); }
      50%{ filter: drop-shadow(0 0 10px rgba(249,226,124,.18)); transform: translateY(-1px); }
    }
    @keyframes divGlowBlue{
      0%,100%{ filter: drop-shadow(0 0 0 rgba(56,189,248,.0)); transform: translateY(0); }
      50%{ filter: drop-shadow(0 0 10px rgba(56,189,248,.16)); transform: translateY(-1px); }
    }
    .div-subhint{
      font-size:11px;
      color:#8aa0b8;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .div-subhint b{color:#e9f2ff;}

    .selection-preview{
      border-top:1px dashed rgba(255,255,255,0.10);
      padding-top:14px;
    }
    .selection-title{
      color:#8aa0b8;
      margin:0 0 10px 0;
      font-size:13px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .selection-title .hint{
      font-size:10px;
      color:#667788;
      font-weight:800;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.22);
      padding:6px 10px;
      border-radius:999px;
    }
    .selection-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width:980px){ .selection-grid{grid-template-columns:1fr;} }

    .sel-card{
      background:rgba(0,0,0,0.22);
      border-radius:14px;
      padding:12px;
      border:1px solid rgba(255,255,255,0.06);
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      overflow:hidden;
    }
    .sel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .sel-head .left{
      display:flex;align-items:center;gap:10px;
      font-weight:900;
      color:#e9f2ff;
      font-size:12px;
    }
    .sel-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.04);
      color:#cfe2ff;
      white-space:nowrap;
    }
    .sel-pill.gold{ border-color: rgba(249,226,124,.22); color:var(--gold-strong); background:rgba(249,226,124,.08); }
    .sel-pill.blue{ border-color: rgba(56,189,248,.22); color:#bfeaff; background:rgba(56,189,248,.08); }

    .sel-list{
      max-height: 160px;
      overflow:auto;
      padding-right:6px;
    }
    .sel-row{
      display:grid;
      grid-template-columns: 1fr 72px;
      gap:10px;
      align-items:center;
      padding:8px 0;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .sel-row:first-child{ border-top:none; padding-top:2px; }
    .sel-name{
      font-weight:900;
      font-size:11px;
      color:#dbeafe;
      line-height:1.25;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
    }
    .sel-w{
      text-align:right;
      font-weight:900;
      font-size:12px;
      color:#fff;
    }
    .sel-empty{
      color:#64748b;
      font-size:11px;
      font-weight:900;
      padding:12px 0;
    }

    .validation-section{margin-top:14px; border-top:1px dashed rgba(255,255,255,0.10); padding-top:14px;}
    .validation-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media (max-width:980px){.validation-grid{grid-template-columns:1fr;}}
    .v-chart-box{background:rgba(0,0,0,0.22); border-radius:14px; padding:12px; border:1px solid rgba(255,255,255,0.06);}
    .v-title{color:#fff;font-size:12px;margin-bottom:8px;font-weight:900;border-left:3px solid #666;padding-left:8px;}
    .v-chart-h{height:180px;position:relative;}

    body.exporting .control-panel{display:none;}
    body.exporting .layout{grid-template-columns:1fr;}
    body.exporting .validation-section{display:none;}
    body.exporting .selection-preview{display:none;}
    body.exporting .title-wrap h1{
      background:none !important;
      -webkit-background-clip:initial !important;
      color: #F9E27C !important;
    }
    body.exporting .lead-card{
      animation:none !important;
      transform:none !important;
      background: rgba(249,226,124,.18) !important;
      border-color: rgba(249,226,124,.25) !important;
      box-shadow: 0 10px 26px rgba(0,0,0,.22) !important;
    }
    body.exporting .lead-card::before,
    body.exporting .lead-card::after{
      display:none !important;
    }
    body.exporting .div-amount.gold,
    body.exporting .div-amount.blu{
      animation:none !important;
    }
    body.exporting .div-amount.gold{ color:#F9E27C !important; background:none !important; -webkit-background-clip:initial !important; }
    body.exporting .div-amount.blu{ color:#BFEAFF !important; background:none !important; -webkit-background-clip:initial !important; }

    #momo-div-pct, #bench-div-pct { display:none !important; }

    @media (max-width:900px){
      body{padding:14px;}
      #report-capture{padding:18px;border-radius:22px;}
      .contact-card{min-width:unset; width:100%;}
      .contact-text .t2{font-size:16px;}
      .title-wrap h1{font-size:24px;}
    }
    @media (max-width:520px){
      #report-capture{padding:14px;border-radius:18px;}
      .header-row{gap:12px;}
      .avatar-ring{width:48px;height:48px;}
      .qrbox{padding:5px;}
      .contact-text .t2{font-size:15px;}
      .title-wrap h1{font-size:22px;}
    }
  </style>
</head>

<body>
  <div id="report-capture">
    <div class="watermark">MOMO FINSPHERE PROFESSIONAL MODEL</div>

    <header>
      <div class="header-row">
        <div class="title-wrap">
          <h1 id="main-title">ã€MOMOé›™è´ç­–ç•¥ã€é…ç½®ç­–ç•¥æ¨æ¼”</h1>
        </div>

        <div class="contact-card">
          <div class="avatar-ring">
            <img id="advisor-avatar" alt="advisor" crossorigin="anonymous" referrerpolicy="no-referrer" />
          </div>
          <div class="qrbox"><div id="qrcode-target"></div></div>
          <div class="contact-text">
            <div class="t1">é¡§å•è¯çµ¡</div>
            <div class="t2">Lineï¼š<span id="line-id">@028tuwbk</span></div>
            <div class="hint">æƒæ QRCode ç«‹å³åŠ å…¥ / è«®è©¢</div>
          </div>
        </div>
      </div>
    </header>

    <div class="layout">
      <div class="control-panel">
        <div class="input-group">
          <label>ç›®å‰æœ¬é‡‘ (TWD)</label>
          <input type="number" id="p0" value="1000000" step="10000" oninput="update()" />
        </div>

        <div class="input-group">
          <label>é€²å ´å€é–“ï¼ˆç”¨æ–¼ä¸»åœ–æ·¨å€¼èµ°å‹¢ï¼‰</label>
          <select id="entry-window" onchange="update()">
            <option value="0">å…¨å‘¨æœŸ</option>
            <option value="1">è¿‘ 1 å¹´</option>
            <option value="3" selected>è¿‘ 3 å¹´</option>
            <option value="5">è¿‘ 5 å¹´</option>
          </select>
        </div>

        <div class="input-group">
          <label>æœªä¾†æ¨æ¼”å¹´æ•¸: <span id="year-display" style="color:#fff">3</span> å¹´</label>
          <input type="range" id="proj-years" min="1" max="10" value="3" oninput="update()" style="padding:0; height:6px;" />
        </div>

        <div class="input-group">
          <button id="btn-toggle-future" onclick="toggleFuture()"
            style="width:100%; padding:8px; background:rgba(255,255,255,0.1); border:1px solid var(--line); color:var(--gold-soft); border-radius:10px; cursor:pointer; font-weight:800; font-size:12px;">
            ğŸ“Š éš±è—æœªä¾†æ¨æ¼”ç·š
          </button>
        </div>

        <div class="gs-box">
          <label>Google Sheet ID</label>
          <input type="text" id="sheet-id" value="1hnk0iEVQv9NdXns_PZ0IGdc3WgkbbqoJs0Zw1EvLWl4" style="font-size:11px; margin-bottom:6px;" />

          <div style="display:flex; gap:8px;">
            <div style="flex:1;">
              <label style="font-size:10px; color:#aaa;">æ·¨å€¼ ID (GID)</label>
              <input type="text" id="sheet-gid" value="877412256" style="font-size:11px;" />
            </div>
            <div style="flex:1;">
                <label style="font-size:10px; color:#aaa;">Config ID (GID)</label>
                <input type="text" id="config-gid" value="1114691785" placeholder="å¡«å…¥GID" style="font-size:11px;" />
            </div>
          </div>
          
          <div style="display:flex; align-items:end; margin-top:8px;">
              <button class="btn-action btn-load" type="button" onclick="fetchSheetData()" style="margin:0; font-size:11px;">
                ğŸ“¡ è®€å–è³‡æ–™ & Config
              </button>
          </div>

          <div id="load-status">
            ç‹€æ…‹ï¼š<b>å°šæœªè®€å–</b><br/>
            è®€å–é †åºï¼šGViz(JSONP) â†’ å¤±æ•—æ‰ CSV fallback
          </div>
        </div>

        <div id="selector-ui" style="display:none;">
          <div class="block-header">ğŸ“ é¸æ“‡æŠ•è³‡çµ„åˆæˆåˆ†</div>

          <input class="fund-filter" id="fund-filter" type="text"
                 placeholder="å¤šé—œéµå­—æœå°‹ï¼šä¾‹å¦‚ã€è²èŠå¾· A2 ç¾å…ƒã€"
                 oninput="applyFundFilter()" />

          <div class="selector-status">
            <div class="sum-badge" id="selected-counts">A å·²é¸ 0 / B å·²é¸ 0</div>
            <label class="toggle-wrap" for="toggle-only-selected" title="å‹¾é¸å¾Œåªé¡¯ç¤ºå·²é¸åŸºé‡‘">
              <input type="checkbox" id="toggle-only-selected" onchange="applyFundFilter()" />
              åªçœ‹å·²é¸
            </label>
          </div>

          <div class="selector-tools">
            <button class="tool-btn danger" type="button" onclick="clearAllSelections()">å…¨éƒ¨æ¸…é™¤</button>
            <button class="tool-btn gold" type="button" onclick="clearSelectionOnly('momo')">æ¸…é™¤ A</button>
            <button class="tool-btn blue" type="button" onclick="clearSelectionOnly('bench')">æ¸…é™¤ B</button>
          </div>

          <div class="fund-selector-container" id="fund-list-container"></div>

          <button class="btn-action btn-refresh" type="button" onclick="applySelection()">ğŸ”„ ç¢ºèªé¸æ“‡ä¸¦æ›´æ–°åœ–è¡¨</button>
          <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;" />
        </div>

        <div class="strat-block momo">
          <div class="block-header"><span style="color:var(--gold-soft)">MOMO ç­–ç•¥çµ„åˆ (A)</span></div>

          <div id="dynamic-weights-area">
            <label style="margin-bottom:8px; color:var(--gold);">æ¬Šé‡è¨­å®š (%)ï¼ˆå¯ğŸ”’é–å®šï¼‰</label>
            <div id="weights-container"></div>
            <div class="lock-hint">
              <span class="sum-badge" id="sum-badge-momo">åˆè¨ˆï¼š0%</span>
              <span>ğŸ”’ é–å®šè€…å›ºå®šï¼Œå…¶é¤˜è‡ªå‹•è£œæ»¿ 100%</span>
            </div>
          </div>

          <div class="sub-input auto-calced" style="margin-top:10px;">
            <label>ä¸å«æ¯ CAGR (%) (ä¾é¸å–å€é–“è‡ªå‹•è¨ˆç®—)</label>
            <input type="number" id="momo-cagr" value="12.77" step="0.01" oninput="update()" />
          </div>
          <div class="sub-input auto-calced" style="margin-bottom:0">
            <label>å¹´é…æ¯ç‡ (%) (ä¾çµ„åˆæ¬Šé‡è‡ªå‹•è¨ˆç®—)</label>
            <input type="number" id="momo-div" value="6.4" step="0.01" oninput="update()" />
          </div>
        </div>

        <div class="strat-block original">
          <div class="block-header"><span style="color:var(--accent-blue)">æ¯”è¼ƒåŸºæº– (B)</span></div>

          <div id="dynamic-weights-area-bench">
            <label style="margin-bottom:8px; color:var(--accent-blue);">æ¬Šé‡è¨­å®š (%)ï¼ˆå¯ğŸ”’é–å®šï¼‰</label>
            <div id="weights-container-bench"></div>
            <div class="lock-hint">
              <span class="sum-badge" id="sum-badge-bench">åˆè¨ˆï¼š0%</span>
              <span>ğŸ”’ é–å®šè€…å›ºå®šï¼Œå…¶é¤˜è‡ªå‹•è£œæ»¿ 100%</span>
            </div>
          </div>

          <div class="sub-input auto-calced" style="margin-top:10px;">
            <label>ä¸å«æ¯ CAGR (%) (ä¾é¸å–å€é–“è‡ªå‹•è¨ˆç®—)</label>
            <input type="number" id="bench-cagr" value="1.51" step="0.01" oninput="update()" />
          </div>
          <div class="sub-input auto-calced" style="margin-bottom:0">
            <label>å¹´é…æ¯ç‡ (%) (ä¾çµ„åˆæ¬Šé‡è‡ªå‹•è¨ˆç®—)</label>
            <input type="number" id="bench-div" value="9.2" step="0.01" oninput="update()" />
          </div>
        </div>

        <button class="btn-export-full" type="button" onclick="exportImg()">åŒ¯å‡ºå®Œæ•´å ±å‘Š</button>
      </div>

      <div>
        <div class="chart-wrapper">
          <div class="chart-title">
            <h4>æ•´åˆè¼¸å‡ºï¼šæ·¨å€¼èµ°å‹¢ï¼ˆä¸å«æ¯ï¼‰</h4>
            <div class="badge" id="year-badge">ç¬¬ 3 å¹´</div>
          </div>
          <div class="chart-canvas-wrap"><canvas id="mainChart"></canvas></div>
        </div>

        <div class="bottom-grid">
          <div class="kpi-row">
            <div class="metric-card">
              <div class="metric-top">
                <div class="metric-title-group">
                  <span class="dot gold"></span> MOMOï½œç¸½å«æ¯åƒ¹å€¼
                </div>
                <span class="pct" id="momo-nav-pct">+0.0%</span>
              </div>

              <div class="big" id="momo-total">$ 0</div>

              <div class="sub">æœŸæœ«æœ¬é‡‘ï¼š<b id="momo-principal" style="color:#fff;">$ 0</b></div>
              <div class="sub">ç´¯ç©é ˜æ¯ï¼š<b id="momo-acc-div" style="color:var(--gold-soft);">$ 0</b></div>
              <div class="sub" style="margin-top:2px; color:#F87171;">âš ï¸ å€é–“æœ€å¤§å›æ’¤ï¼š<b id="momo-mdd">-0.0%</b></div>
            </div>

            <div class="metric-card">
              <div class="metric-top">
                <div class="metric-title-group">
                  <span class="dot blue"></span> åŸå§‹æ–¹æ¡ˆï½œç¸½å«æ¯åƒ¹å€¼
                </div>
                <span class="pct" id="bench-nav-pct">+0.0%</span>
              </div>

              <div class="big" id="bench-total">$ 0</div>

              <div class="sub">æœŸæœ«æœ¬é‡‘ï¼š<b id="bench-principal" style="color:#fff;">$ 0</b></div>
              <div class="sub">ç´¯ç©é ˜æ¯ï¼š<b id="bench-acc-div" style="color:#bfeaff;">$ 0</b></div>
              <div class="sub" style="margin-top:2px; color:#F87171;">âš ï¸ å€é–“æœ€å¤§å›æ’¤ï¼š<b id="bench-mdd">-0.0%</b></div>
            </div>

            <div class="metric-card lead-card" id="lead-card">
              <div class="lead-topline">
                <div class="metric-top" style="margin:0; width:auto;">
                   <div class="metric-title-group">
                     <span class="dot lead"></span> é ˜å…ˆåƒ¹å€¼ï¼ˆA - Bï¼‰
                   </div>
                </div>
                <div class="lead-pct" id="lead-pct">+0.0%</div>
              </div>

              <div class="big" id="lead-value">$ 0</div>
              <div class="sub">æœ¬é‡‘å·®é¡ï¼š<b id="lead-principal-diff">$ 0</b></div>
              <div class="sub">é ˜æ¯å·®é¡ï¼š<b id="lead-div-diff">$ 0</b></div>
            </div>
          </div>

          <div class="kpi-row">
            <div class="metric-card div-card">
              <div class="metric-top">
                <div class="metric-title-group">
                  <span class="dot gold"></span> MOMOï½œç´¯ç©é ˜é…æ¯
                </div>
              </div>
              <div class="div-amount gold" id="momo-div-amount">$ 0</div>
              <div class="div-subhint">ä¼°ç®—ä¾æ“šï¼š<b>èµ·å§‹æœ¬é‡‘ Ã— å¹´é…æ¯ç‡</b>ï¼ˆå›ºå®šæ¨ä¼°ï¼‰</div>
            </div>

            <div class="metric-card div-card blue">
              <div class="metric-top">
                <div class="metric-title-group">
                  <span class="dot blue"></span> åŸå§‹æ–¹æ¡ˆï½œç´¯ç©é ˜é…æ¯
                </div>
              </div>
              <div class="div-amount blu" id="bench-div-amount">$ 0</div>
              <div class="div-subhint">ä¼°ç®—ä¾æ“šï¼š<b>èµ·å§‹æœ¬é‡‘ Ã— å¹´é…æ¯ç‡</b>ï¼ˆå›ºå®šæ¨ä¼°ï¼‰</div>
            </div>

            <div class="metric-card" style="opacity:0; pointer-events:none;"></div>
          </div>

          <div class="selection-preview">
            <div class="selection-title">
              <span>ğŸ‘ï¸ çµ„åˆé¸å–æ˜ç´°ï¼ˆåƒ…æª¢è¦–ï¼‰</span>
              <span class="hint">æ­¤å€å¡ŠåŒ¯å‡ºæˆªåœ–æœƒè‡ªå‹•éš±è—</span>
            </div>

            <div class="selection-grid">
              <div class="sel-card">
                <div class="sel-head">
                  <div class="left"><span class="dot gold"></span> A çµ„åˆï¼ˆMOMOï¼‰</div>
                  <div class="sel-pill gold" id="sel-pill-a">å·²é¸ 0ï½œåˆè¨ˆ 0.0%</div>
                </div>
                <div class="sel-list" id="sel-list-a">
                  <div class="sel-empty">å°šæœªé¸æ“‡åŸºé‡‘</div>
                </div>
              </div>

              <div class="sel-card">
                <div class="sel-head">
                  <div class="left"><span class="dot blue"></span> B çµ„åˆï¼ˆåŸºæº–ï¼‰</div>
                  <div class="sel-pill blue" id="sel-pill-b">å·²é¸ 0ï½œåˆè¨ˆ 0.0%</div>
                </div>
                <div class="sel-list" id="sel-list-b">
                  <div class="sel-empty">å°šæœªé¸æ“‡åŸºé‡‘</div>
                </div>
              </div>
            </div>
          </div>

          <div class="validation-section">
            <h4 style="color:#8aa0b8; margin:0 0 10px 0; font-size:13px; font-weight:900;">ğŸ›  ä¸Šå‚³æ•¸æ“šé©—è­‰å€ï¼ˆèµ°å‹¢ %ï¼‰</h4>
            <div class="validation-grid">
              <div class="v-chart-box">
                <div class="v-title" style="border-color:var(--accent-blue)">æ¯”è¼ƒåŸºæº–èµ°å‹¢</div>
                <div class="v-chart-h"><canvas id="valBenchChart"></canvas></div>
              </div>
              <div class="v-chart-box">
                <div class="v-title" style="border-color:var(--gold)">æˆåˆ†åŸºé‡‘èµ°å‹¢</div>
                <div class="v-chart-h"><canvas id="valMomoChart"></canvas></div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <script>
    const ADVISOR_AVATAR_URL = "https://crmpos.mecango.com/_files/49/9040149/f/chromalab-edited.png";
    const LINE_QR_URL = "https://lin.ee/kaDnVUj";

    function parseDateLoose(v){
      if(!v) return null;
      if(v instanceof Date && !isNaN(v.getTime())) return v;
      const s = String(v).trim();
      if(!s) return null;
      const g = s.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
      if(g) return new Date(parseInt(g[1],10), parseInt(g[2],10), parseInt(g[3],10));
      const m = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})(?:\s.*)?$/);
      if(m) return new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
      const t = Date.parse(s);
      if(Number.isFinite(t)) return new Date(t);
      return null;
    }
    function dateKey(dt){
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const d = String(dt.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    const nf0 = new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 });
    const money = v => `$ ${nf0.format(Math.round(v || 0))}`;

    const BRAND_COLORS = [
      { keys: ["æ–½ç¾…å¾·","Schroder"], color:"#A78BFA" },
      { keys: ["å®‰è¯","Allianz"], color:"#38BDF8" },
      { keys: ["çµ±ä¸€"], color:"#F97316" },
      { keys: ["è²èŠå¾·","BlackRock","iShares"], color:"#F9E27C" },
      { keys: ["è¯åš","AB"], color:"#34D399" },
      { keys: ["å¯Œé”","Fidelity"], color:"#22C55E" },
      { keys: ["æ‘©æ ¹","JPM","JP Morgan"], color:"#60A5FA" },
      { keys: ["æ™¯é †","Invesco"], color:"#F87171" },
      { keys: ["å¯Œé‚¦"], color:"#93C5FD" },
      { keys: ["åœ‹æ³°"], color:"#10B981" },
      { keys: ["å…ƒå¤§"], color:"#FBBF24" },
      { keys: ["ç¾¤ç›Š"], color:"#FB7185" },
      { keys: ["ä¸­ä¿¡","ä¸­åœ‹ä¿¡è¨—"], color:"#67E8F9" },
      { keys: ["å…†è±"], color:"#FCA5A5" },
      { keys: ["é‡æ‘"], color:"#C084FC" },
      { keys: ["å¾©è¯"], color:"#FDE68A" }
    ];
    function getBrandColor(name){
      const n = String(name||"").toLowerCase();
      for(const b of BRAND_COLORS){
        for(const k of b.keys){
          if(n.includes(k.toLowerCase())) return b.color;
        }
      }
      return "rgba(207,226,255,0.55)";
    }

    let showFuture = true;
    let rawGlobalData = [];
    let allFundNames = [];
    let parsedBenchData = [], parsedMomoData = [], momoFundNames = [], benchFundNames = [];
    // Config å°æ‡‰è¡¨
    let fundConfigMap = {};

    let mainChart = null, vBenchChart = null, vMomoChart = null;
    const weightState = { momo: new Map(), bench: new Map() };

    function setStatus(html){
      const el = document.getElementById('load-status');
      if(el) el.innerHTML = html;
    }

    function gvizJsonp(sheetId, gid){
      return new Promise((resolve, reject) => {
        const cbName = `__gviz_cb_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const timeoutMs = 12000;
        let done = false;

        const timer = setTimeout(() => {
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("GViz é€¾æ™‚ï¼ˆå¯èƒ½æœªå…¬é–‹/æœªç™¼å¸ƒåˆ°ç¶²è·¯ï¼‰"));
        }, timeoutMs);

        function cleanup(){
          try{ delete window[cbName]; }catch(_){}
          const s = document.getElementById(cbName);
          if(s && s.parentNode) s.parentNode.removeChild(s);
          clearTimeout(timer);
        }

        window[cbName] = (resp) => {
          if(done) return;
          done = true;
          cleanup();
          resolve(resp);
        };

        const script = document.createElement('script');
        script.id = cbName;
        script.async = true;
        const tqx = `responseHandler:${cbName};out:json`;
        script.src =
          `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheetId)}/gviz/tq` +
          `?gid=${encodeURIComponent(gid)}` +
          `&headers=1` +
          `&tqx=${encodeURIComponent(tqx)}`;

        script.onerror = () => {
          if(done) return;
          done = true;
          cleanup();
          reject(new Error("GViz JSONP è¼‰å…¥å¤±æ•—"));
        };

        document.head.appendChild(script);
      });
    }

    function gvizToRows(resp){
      if(!resp || !resp.table) throw new Error("GViz å›å‚³æ ¼å¼ç•°å¸¸");
      const t = resp.table;
      const headers = (t.cols || []).map(c => (c && c.label) ? String(c.label).trim() : "");
      const rows = [ headers ];
      (t.rows || []).forEach(r => {
        const cells = (r.c || []);
        const arr = cells.map(cell => {
          if(!cell) return null;
          return (cell.v !== undefined && cell.v !== null) ? cell.v : (cell.f ?? null);
        });
        rows.push(arr);
      });
      return rows;
    }

    async function fetchCsvFallback(sheetId, gid){
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
      const res = await fetch(url, { cache:"no-store", redirect:"follow" });
      if (!res.ok) throw new Error("CSV fetch å¤±æ•— (404/403/CORS)");
      const buffer = await res.arrayBuffer();
      const decoder = new TextDecoder("utf-8");
      const csvText = decoder.decode(buffer);
      const workbook = XLSX.read(csvText, {type: 'string'});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      return XLSX.utils.sheet_to_json(sheet, {header: 1, raw: true});
    }

    // âœ… è™•ç† Config è³‡æ–™ (ä¿®æ­£ç‰ˆï¼šBæ¬„åç¨±, Dæ¬„é…æ¯)
    function processConfigData(rows) {
        fundConfigMap = {};
        if(!rows || rows.length < 2) return;
        
        console.log("æ­£åœ¨è™•ç† Config åˆ†é è³‡æ–™ (ä¾†æº: Bæ¬„åç¨±, Dæ¬„é…æ¯)...");
        
        for(let i=1; i<rows.length; i++) {
            const row = rows[i];
            const rawName = String(row[1] || "").trim(); // Bæ¬„ (index 1)
            const rateRaw = row[3]; // Dæ¬„ (index 3)
            
            // æ·¨åŒ–åç¨±ï¼šè½‰å°å¯«ã€ç§»é™¤ç©ºæ ¼ã€ç§»é™¤å¸¸è¦‹ç¬¦è™Ÿï¼Œä½œç‚ºå°ç…§ Key
            const cleanKey = rawName.toLowerCase().replace(/\s+/g, '').replace(/[-_()]/g, '');
            
            let rate = 0;
            if(typeof rateRaw === 'number') {
                rate = rateRaw;
            } else if(typeof rateRaw === 'string') {
                rate = parseFloat(rateRaw.replace(/%/g, '').trim());
            }

            // é˜²å‘†ï¼šå¦‚æœè®€å‡ºä¾†æ˜¯ 0.06 (å°æ•¸)ï¼Œè½‰æˆ 6.0 (%)
            if(rate > 0 && rate < 1) rate = rate * 100;

            if(cleanKey && !isNaN(rate)) {
                fundConfigMap[cleanKey] = rate;
                fundConfigMap["__RAW__" + cleanKey] = rawName;
            }
        }
        console.log(`âœ… Config è®€å–å®Œæˆï¼Œå…±è¼‰å…¥ ${Object.keys(fundConfigMap).length / 2} ç­†é…æ¯è³‡æ–™`);
    }

    // âœ… è®€å–è³‡æ–™ä¸»ç¨‹å¼
    async function fetchSheetData() {
      const sheetId = document.getElementById('sheet-id').value.trim();
      const navGid = document.getElementById('sheet-gid').value.trim();
      const configGid = document.getElementById('config-gid').value.trim();

      if (!sheetId) { alert("è«‹è¼¸å…¥ Google Sheet ID"); return; }
      if (!navGid) { alert("è«‹è¼¸å…¥ æ·¨å€¼ GID"); return; }

      const btn = document.querySelector('.btn-load');
      const oldText = btn ? btn.innerHTML : "";
      if(btn){ btn.innerHTML = "â³ é€£ç·šä¸­..."; btn.disabled = true; }

      setStatus(`ç‹€æ…‹ï¼š<b>è®€å–ä¸­â€¦</b><br/>åŒæ­¥è®€å– æ·¨å€¼ & Config`);

      try {
        const pNav = gvizJsonp(sheetId, navGid)
             .then(resp => gvizToRows(resp))
             .catch(() => fetchCsvFallback(sheetId, navGid));
        
        let pConfig = Promise.resolve([]);
        if(configGid) {
            pConfig = gvizJsonp(sheetId, configGid)
                .then(resp => gvizToRows(resp))
                .catch(() => fetchCsvFallback(sheetId, configGid));
        }

        const [navRows, configRows] = await Promise.all([pNav, pConfig]);

        if (!navRows || navRows.length < 2) throw new Error("æ·¨å€¼è³‡æ–™ç‚ºç©º");
        
        // 1. è™•ç† Config
        if(configRows && configRows.length > 1) {
            processConfigData(configRows);
        } else {
            console.warn("âš ï¸ Config è³‡æ–™ç‚ºç©ºæˆ–è®€å–å¤±æ•—");
        }

        // 2. è™•ç† Nav
        processRawSheetData(navRows);

        // 3. å¼·åˆ¶åˆ·æ–°è¨ˆç®—
        if(momoFundNames.length > 0) normalizeWeightsTo100('momo');
        if(benchFundNames.length > 0) normalizeWeightsTo100('bench');

        document.getElementById('selector-ui').style.display = 'block';
        setStatus(`ç‹€æ…‹ï¼š<b>è®€å–æˆåŠŸ</b><br/>æ·¨å€¼ç­†æ•¸ï¼š${rawGlobalData.length}ï½œConfig å°æ‡‰ï¼š${Object.keys(fundConfigMap).length/2}`);

      } catch (e) {
        console.error(e);
        setStatus(`ç‹€æ…‹ï¼š<b>è®€å–å¤±æ•—</b><br/>${e.message}`);
        alert(`âŒ è®€å–å¤±æ•—ï¼è«‹æª¢æŸ¥ ID/GID èˆ‡æ¬Šé™è¨­å®šã€‚\néŒ¯èª¤ï¼š${e.message}`);
      } finally {
        if(btn){ btn.innerHTML = oldText; btn.disabled = false; }
      }
    }

    function processRawSheetData(rows) {
      const headers = rows[0] || [];
      allFundNames = headers.slice(1).map(h => String(h ?? "").trim()).filter(Boolean);
      rawGlobalData = [];

      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i];
        if (!cols || cols.length === 0) continue;

        const dt = parseDateLoose(cols[0]);
        if (!dt) continue;

        const rowObj = { dt: dt, dateKey: dateKey(dt), valsRaw: {}, valsFilled: {} };
        for (let j = 0; j < allFundNames.length; j++) {
          const colIdx = j + 1;
          let val = cols[colIdx];
          if (typeof val === 'string') val = parseFloat(val.replace(/,/g, ''));
          const clean = (Number.isFinite(val) && val > 0) ? val : null;
          rowObj.valsRaw[allFundNames[j]] = clean;
          rowObj.valsFilled[allFundNames[j]] = clean;
        }
        rawGlobalData.push(rowObj);
      }
      rawGlobalData.sort((a,b) => a.dt - b.dt);

      // Forward fill
      const lastValid = {};
      allFundNames.forEach(n => lastValid[n] = null);
      rawGlobalData.forEach(row => {
        allFundNames.forEach(n => {
          if (row.valsFilled[n] !== null) lastValid[n] = row.valsFilled[n];
          else row.valsFilled[n] = lastValid[n];
        });
      });

      renderFundSelectors();
      renderSelectionPreview();
      update();
    }

    function updateSelectedCounts(){
      const a = document.querySelectorAll('.momo-chk:checked').length;
      const b = document.querySelectorAll('.bench-chk:checked').length;
      const el = document.getElementById('selected-counts');
      if(el) el.textContent = `A å·²é¸ ${a} / B å·²é¸ ${b}`;
    }

    function applyFundFilter(){
      const qRaw = (document.getElementById('fund-filter')?.value || "").trim().toLowerCase();
      const tokens = qRaw ? qRaw.split(/\s+/).filter(Boolean) : [];
      const onlySelected = !!document.getElementById('toggle-only-selected')?.checked;

      const items = document.querySelectorAll('#fund-list-container .fund-item');
      items.forEach((el, idx) => {
        if(idx === 0) return;

        const name = (el.dataset.name || "");
        const momo = el.querySelector('.momo-chk')?.checked;
        const bench = el.querySelector('.bench-chk')?.checked;

        let okSearch = true;
        if(tokens.length){
          okSearch = tokens.every(t => name.includes(t));
        }
        let okSelected = true;
        if(onlySelected){
          okSelected = !!(momo || bench);
        }

        el.style.display = (okSearch && okSelected) ? '' : 'none';
      });

      updateSelectedCounts();
    }

    function renderFundSelectors() {
      const container = document.getElementById('fund-list-container');
      container.innerHTML = `
        <div class="fund-item" style="position:sticky; top:0; background:#000; z-index:2; border-bottom:1px solid rgba(255,255,255,0.12); color:#fff; padding-top:10px; padding-bottom:10px;">
          <div style="padding-left:4px; font-weight:900;">åŸºé‡‘åç¨±</div>
          <div class="chk-col" style="color:var(--gold); font-weight:900;">MOMO<br>(A)</div>
          <div class="chk-col" style="color:var(--accent-blue); font-weight:900;">åŸºæº–<br>(B)</div>
        </div>
      `;

      allFundNames.forEach((name) => {
        const color = getBrandColor(name);
        const div = document.createElement('div');
        div.className = 'fund-item';
        div.dataset.name = name.toLowerCase();
        div.innerHTML = `
          <div class="fund-name" title="${name}">
            <span class="brand-dot" style="background:${color}"></span>
            <span class="brand-text" style="color:${color}; opacity:.95">${name}</span>
          </div>
          <div class="chk-col"><input type="checkbox" class="momo-chk" data-name="${name}" /></div>
          <div class="chk-col"><input type="checkbox" class="bench-chk" data-name="${name}" /></div>
        `;

        div.querySelector('.momo-chk').addEventListener('change', () => { updateSelectedCounts(); applyFundFilter(); });
        div.querySelector('.bench-chk').addEventListener('change', () => { updateSelectedCounts(); applyFundFilter(); });

        container.appendChild(div);
      });

      applyFundFilter();
      updateSelectedCounts();
    }

    function clearAllSelections(){
      document.querySelectorAll('.momo-chk,.bench-chk').forEach(c => c.checked = false);
      momoFundNames = []; benchFundNames = [];
      parsedMomoData = []; parsedBenchData = [];
      generateWeightInputs('momo', []);
      generateWeightInputs('bench', []);
      updateValidationChart('momo');
      updateValidationChart('bench');
      renderSelectionPreview();
      applyFundFilter();
      update();
    }

    function clearSelectionOnly(type){
      const cls = type === 'momo' ? '.momo-chk' : '.bench-chk';
      document.querySelectorAll(cls).forEach(c => c.checked = false);
      if(type === 'momo'){ momoFundNames = []; parsedMomoData = []; generateWeightInputs('momo', []); updateValidationChart('momo'); }
      if(type === 'bench'){ benchFundNames = []; parsedBenchData = []; generateWeightInputs('bench', []); updateValidationChart('bench'); }
      renderSelectionPreview();
      applyFundFilter();
      update();
    }

    function applySelection() {
      const momoChks = document.querySelectorAll('.momo-chk:checked');
      const benchChks = document.querySelectorAll('.bench-chk:checked');
      momoFundNames = Array.from(momoChks).map(c => c.dataset.name);
      benchFundNames = Array.from(benchChks).map(c => c.dataset.name);

      if (momoFundNames.length === 0 && benchFundNames.length === 0) {
        alert("è«‹è‡³å°‘é¸æ“‡ä¸€æ”¯åŸºé‡‘ï¼");
        return;
      }

      parsedMomoData = rawGlobalData.map(row => ({ dt: row.dt, date: row.dateKey, vals: momoFundNames.map(n => row.valsRaw[n]) }));
      parsedBenchData = rawGlobalData.map(row => ({ dt: row.dt, date: row.dateKey, vals: benchFundNames.map(n => row.valsRaw[n]) }));

      generateWeightInputs('momo', momoFundNames);
      generateWeightInputs('bench', benchFundNames);

      normalizeWeightsTo100('momo');
      normalizeWeightsTo100('bench');

      updateValidationChart('momo');
      updateValidationChart('bench');
      renderSelectionPreview();
      updateSelectedCounts();
      update();
    }

    function getRowEls(type){
      const containerId = type === 'momo' ? 'weights-container' : 'weights-container-bench';
      return Array.from(document.querySelectorAll(`#${containerId} .weight-row`));
    }
    function readWeightsFromDOM(type){
      const rows = getRowEls(type);
      return rows.map(r => {
        const name = r.dataset.name;
        const val = parseFloat(r.querySelector('.weight-input')?.value) || 0;
        const locked = !!r.querySelector('.lock-chk')?.checked;
        return { name, val, locked, row: r };
      });
    }
    function writeWeightToDOM(item, val){
      const input = item.row.querySelector('.weight-input');
      if(input) input.value = (Math.round(val * 10) / 10).toFixed(1);
    }
    function syncStateFromDOM(type){
      const arr = readWeightsFromDOM(type);
      arr.forEach(it => {
        weightState[type].set(it.name, { value: it.val, locked: it.locked });
      });
      setSumBadge(type);
    }
    function setSumBadge(type){
      const arr = readWeightsFromDOM(type);
      const sum = arr.reduce((a,b)=>a+(b.val||0),0);
      const el = document.getElementById(type === 'momo' ? 'sum-badge-momo' : 'sum-badge-bench');
      if(!el) return;
      el.textContent = `åˆè¨ˆï¼š${(Math.round(sum*10)/10).toFixed(1)}%`;
      el.classList.remove('good','warn');
      if(Math.abs(sum - 100) <= 0.2) el.classList.add('good');
      else el.classList.add('warn');
    }

    // âœ… è¨ˆç®—åŠ æ¬Šå¹³å‡é…æ¯ç‡ (å«æ¨¡ç³Šæœå°‹)
    function updateWeightedDiv(type) {
        const arr = readWeightsFromDOM(type);
        if(!arr || arr.length === 0) return;
        
        const totalWeight = arr.reduce((a,b) => a + (b.val||0), 0);
        let weightedRate = 0;
        let foundCount = 0;

        arr.forEach(item => {
            const w = item.val || 0;
            const currentName = item.name;
            const searchKey = currentName.toLowerCase().replace(/\s+/g, '').replace(/[-_()]/g, '');
            
            // å˜—è©¦ç›´æ¥æŸ¥æ‰¾
            let rate = fundConfigMap[searchKey];

            // æ‰¾ä¸åˆ°å‰‡æ¨¡ç³Šæœå°‹
            if (rate === undefined) {
                const fuzzyKey = Object.keys(fundConfigMap).find(k => 
                    !k.startsWith("__RAW__") && (k.includes(searchKey) || searchKey.includes(k))
                );
                if(fuzzyKey) {
                    rate = fundConfigMap[fuzzyKey];
                    console.log(`ğŸ” æ¨¡ç³Šæ¯”å°æˆåŠŸ: [${currentName}] -> ${rate}%`);
                }
            }

            if (rate !== undefined) {
                weightedRate += rate * w;
                foundCount++;
            } else {
                console.warn(`âš ï¸ æ‰¾ä¸åˆ°é…æ¯ç‡: [${currentName}]`);
            }
        });

        let finalRate = 0;
        if(totalWeight > 0) {
            finalRate = weightedRate / totalWeight; 
        }

        const inputId = type === 'momo' ? 'momo-div' : 'bench-div';
        const inputEl = document.getElementById(inputId);
        if(inputEl) {
            inputEl.value = finalRate.toFixed(2);
            inputEl.style.color = (foundCount === 0 && arr.length > 0) ? '#ff6b6b' : '';
        }
    }

    function normalizeWeightsTo100(type, changedName=null){
      const arr = readWeightsFromDOM(type);
      if(arr.length === 0) { renderSelectionPreview(); return; }

      const locked = arr.filter(x=>x.locked);
      const unlocked = arr.filter(x=>!x.locked);

      let lockedSum = locked.reduce((a,b)=>a + (b.val||0), 0);
      lockedSum = Math.max(0, lockedSum);

      if(lockedSum > 100){
        const ratio = 100 / lockedSum;
        locked.forEach(it => writeWeightToDOM(it, (it.val||0) * ratio));
        unlocked.forEach(it => writeWeightToDOM(it, 0));
        syncStateFromDOM(type);
        renderSelectionPreview();
        updateWeightedDiv(type); // âœ… æ›´æ–°é…æ¯
        return;
      }

      const budget = 100 - lockedSum;
      if(unlocked.length === 0){
        syncStateFromDOM(type);
        renderSelectionPreview();
        updateWeightedDiv(type); // âœ… æ›´æ–°é…æ¯
        return;
      }

      let fixedName = changedName && unlocked.some(x=>x.name===changedName) ? changedName : null;

      if(fixedName){
        const fixedItem = unlocked.find(x=>x.name===fixedName);
        let fixedVal = Math.min(Math.max(fixedItem.val||0, 0), budget);
        writeWeightToDOM(fixedItem, fixedVal);

        const others = unlocked.filter(x=>x.name!==fixedName);
        if(others.length === 0){
          writeWeightToDOM(fixedItem, budget);
          syncStateFromDOM(type);
          renderSelectionPreview();
          updateWeightedDiv(type); // âœ… æ›´æ–°é…æ¯
          return;
        }

        const otherSum = others.reduce((a,b)=>a+(b.val||0),0);
        const remain = Math.max(0, budget - fixedVal);

        if(otherSum <= 0){
          const each = remain / others.length;
          others.forEach(it => writeWeightToDOM(it, each));
        } else {
          others.forEach(it => writeWeightToDOM(it, (it.val||0) / otherSum * remain));
        }
      } else {
        const sumU = unlocked.reduce((a,b)=>a+(b.val||0),0);
        if(sumU <= 0){
          const each = budget / unlocked.length;
          unlocked.forEach(it => writeWeightToDOM(it, each));
        } else {
          unlocked.forEach(it => writeWeightToDOM(it, (it.val||0) / sumU * budget));
        }
      }

      syncStateFromDOM(type);
      renderSelectionPreview();
      updateWeightedDiv(type); // âœ… æ›´æ–°é…æ¯
    }

    function onWeightChange(type, name){
      syncStateFromDOM(type);
      normalizeWeightsTo100(type, name);
      update();
    }
    function onLockToggle(type){
      syncStateFromDOM(type);
      normalizeWeightsTo100(type, null);
      update();
    }

    function generateWeightInputs(type, names) {
      const containerId = type === 'momo' ? 'weights-container' : 'weights-container-bench';
      const areaId = type === 'momo' ? 'dynamic-weights-area' : 'dynamic-weights-area-bench';
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      if (names.length <= 0) {
        document.getElementById(areaId).style.display = 'none';
        setSumBadge(type);
        renderSelectionPreview();
        return;
      }

      const avg = (100 / names.length);
      names.forEach(n => {
        if(!weightState[type].has(n)){
          weightState[type].set(n, { value: avg, locked: false });
        }
      });

      names.forEach(n => {
        const st = weightState[type].get(n) || { value: avg, locked: false };

        const row = document.createElement('div');
        row.className = 'weight-row';
        row.dataset.name = n;

        row.innerHTML = `
          <label title="${n}">${n}</label>
          <input type="number" class="weight-input" value="${(Math.round((st.value||0)*10)/10).toFixed(1)}" step="0.1" />
          <div class="weight-lock" title="é–å®šæ­¤æ¯”ä¾‹">
            <input type="checkbox" class="lock-chk" ${st.locked ? 'checked' : ''} />
            <span>ğŸ”’</span>
          </div>
        `;

        const input = row.querySelector('.weight-input');
        const lock = row.querySelector('.lock-chk');
        input.addEventListener('change', () => onWeightChange(type, n));
        lock.addEventListener('change', () => onLockToggle(type));
        container.appendChild(row);
      });

      document.getElementById(areaId).style.display = 'block';
      syncStateFromDOM(type);
      renderSelectionPreview();
    }

    function getWeights(type) {
      const names = type === 'momo' ? momoFundNames : benchFundNames;
      if (names.length === 0) return [];
      const arr = readWeightsFromDOM(type);
      const map = new Map(arr.map(x => [x.name, x.val]));
      const w = names.map(n => Math.max(0, map.get(n) || 0));
      const sum = w.reduce((a,b)=>a+b,0);
      if(sum <= 0) return new Array(names.length).fill(1/names.length);
      return w.map(x => x/sum);
    }

    function renderSelectionPreview(){
      const pillA = document.getElementById('sel-pill-a');
      const pillB = document.getElementById('sel-pill-b');
      const listA = document.getElementById('sel-list-a');
      const listB = document.getElementById('sel-list-b');
      if(!pillA || !pillB || !listA || !listB) return;

      function build(type){
        const names = type === 'momo' ? momoFundNames : benchFundNames;
        const arr = readWeightsFromDOM(type).map(x => ({ name:x.name, w: (x.val||0) }));
        const map = new Map(arr.map(x => [x.name, x.w]));
        const items = names.map(n => ({ name:n, w: (map.get(n) ?? 0) }));
        const sum = items.reduce((a,b)=>a+b.w,0);
        return { items, sum, count: names.length };
      }

      const A = build('momo');
      const B = build('bench');

      pillA.textContent = `å·²é¸ ${A.count}ï½œåˆè¨ˆ ${A.sum.toFixed(1)}%`;
      pillB.textContent = `å·²é¸ ${B.count}ï½œåˆè¨ˆ ${B.sum.toFixed(1)}%`;

      function renderList(el, items){
        if(!items || items.length === 0){
          el.innerHTML = `<div class="sel-empty">å°šæœªé¸æ“‡åŸºé‡‘</div>`;
          return;
        }
        el.innerHTML = items.map(it => `
          <div class="sel-row">
            <div class="sel-name" title="${it.name}">${it.name}</div>
            <div class="sel-w">${(Math.round((it.w||0)*10)/10).toFixed(1)}%</div>
          </div>
        `).join('');
      }

      renderList(listA, A.items);
      renderList(listB, B.items);
    }

    function createVChart(ctx, labels, datasets) {
      return new Chart(ctx, {
        type:'line',
        data:{ labels, datasets },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ x:{ display:false }, y:{ grid:{color:'rgba(255,255,255,0.06)'}, ticks:{display:false} } },
          plugins:{ legend:{display:false}, tooltip:{enabled:false} }
        }
      });
    }

    function updateValidationChart(type){
      const id = type==='bench' ? 'valBenchChart' : 'valMomoChart';
      const names = type==='bench' ? benchFundNames : momoFundNames;
      const canvas = document.getElementById(id);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');

      if(!names || names.length === 0 || !rawGlobalData || rawGlobalData.length === 0){
        if(type==='bench' && vBenchChart) {vBenchChart.destroy(); vBenchChart=null;}
        if(type==='momo' && vMomoChart) {vMomoChart.destroy(); vMomoChart=null;}
        return;
      }

      const startIdxs = [];
      for(const n of names){
        let s=-1;
        for(let k=0;k<rawGlobalData.length;k++){
          const v = rawGlobalData[k].valsFilled[n];
          if(v!==null && v>0){ s=k; break; }
        }
        if(s>=0) startIdxs.push(s);
      }
      const globalStart = startIdxs.length ? Math.min(...startIdxs) : 0;

      const sliced = rawGlobalData.slice(globalStart);
      const labels = sliced.map(r => r.dateKey);

      const momoColors  = ['#F9E27C','#F87171','#34D399','#A78BFA','#FB923C','#FFFFFF'];
      const benchColors = ['#38BDF8','#A78BFA','#34D399','#F9E27C','#FB923C','#F87171','#FFFFFF'];

      const ds = names.map((n,i)=>{
        let startVal=null, startPos=-1;
        for(let k=0;k<sliced.length;k++){
          const v = sliced[k].valsFilled[n];
          if(v!==null && v>0){ startVal=v; startPos=k; break; }
        }

        const data = sliced.map((row,idx)=>{
          if(startVal===null) return null;
          if(idx < startPos) return null;
          const v = row.valsFilled[n];
          if(v===null) return null;
          return ((v-startVal)/startVal)*100;
        });

        const color = (type==='bench') ? benchColors[i % benchColors.length] : momoColors[i % momoColors.length];
        return { label:n, data, borderColor:color, borderWidth:1.6, pointRadius:0, tension:0.12, spanGaps:true };
      });

      if(type==='bench'){
        if(vBenchChart) vBenchChart.destroy();
        vBenchChart = createVChart(ctx, labels, ds);
      }else{
        if(vMomoChart) vMomoChart.destroy();
        vMomoChart = createVChart(ctx, labels, ds);
      }
    }

    function calculateMaxDrawdown(prices) {
      if (!prices || prices.length < 2) return 0;
      let maxPeak = prices[0];
      let maxDrawdown = 0;
      for (let p of prices) {
        if (p > maxPeak) maxPeak = p;
        const dd = (p - maxPeak) / maxPeak;
        if (dd < maxDrawdown) maxDrawdown = dd;
      }
      return maxDrawdown * 100;
    }

    function processHistoryPrincipal(p0, lookbackYears){
      if(parsedMomoData.length === 0 || parsedBenchData.length === 0) {
        return { labels:[], momoPrincipal:[], benchPrincipal:[], lastDate:new Date() };
      }
      const wMomo = getWeights('momo');
      const wBench = getWeights('bench');
      const combined = [];

      for(let k=0; k<parsedMomoData.length; k++){
        const mRow = parsedMomoData[k];
        const bRow = parsedBenchData[k];
        const mValid = (mRow.vals.length===0) ? false : mRow.vals.every(v => v!==null && v>0);
        const bValid = (bRow.vals.length===0) ? false : bRow.vals.every(v => v!==null && v>0);
        if(mValid && bValid){
          combined.push({ date: mRow.date, dt: mRow.dt, mVals: mRow.vals, bVals: bRow.vals });
        }
      }
      if(combined.length < 2) return { labels:[], momoPrincipal:[], benchPrincipal:[], lastDate:new Date() };

      let cut = combined;
      if(lookbackYears && lookbackYears > 0){
        const lastDt = combined[combined.length-1].dt;
        const cutoff = new Date(lastDt.getFullYear(), lastDt.getMonth(), lastDt.getDate() - Math.round(lookbackYears*365));
        const sliced = combined.filter(r => r.dt >= cutoff);
        if(sliced.length >= 2) cut = sliced;
      }

      const mBase = cut[0].mVals;
      const bBase = cut[0].bVals;

      function calcIndex(vals, baseVals, weights){
        let sum = 0;
        for(let i=0; i<vals.length; i++) sum += (vals[i] / baseVals[i]) * (weights[i] ?? 0);
        return sum;
      }

      const momoIdx = cut.map(r => calcIndex(r.mVals, mBase, wMomo));
      const benchIdx = cut.map(r => calcIndex(r.bVals, bBase, wBench));

      return {
        labels: cut.map(r => r.date),
        momoPrincipal: momoIdx.map(x => p0 * x),
        benchPrincipal: benchIdx.map(x => p0 * x),
        lastDate: cut[cut.length-1].dt
      };
    }

    function toggleFuture() {
      showFuture = !showFuture;
      const btn = document.getElementById('btn-toggle-future');
      if (showFuture) { btn.innerText = "ğŸ“Š éš±è—æœªä¾†æ¨æ¼”ç·š"; btn.style.color = "var(--gold-soft)"; }
      else { btn.innerText = "ğŸ“ˆ é¡¯ç¤ºæœªä¾†æ¨æ¼”ç·š"; btn.style.color = "var(--muted)"; }
      update();
    }

    // âœ… ä¿®æ­£ç‰ˆï¼šè‡ªå‹•è¨ˆç®—æ­·å² CAGR ä¸¦å¡«å…¥ï¼Œç„¶å¾Œç•«åœ–
    function buildSeries(){
      const p0 = parseFloat(document.getElementById('p0').value)||0;
      const years = parseInt(document.getElementById('proj-years').value)||3;
      document.getElementById('year-display').innerText = years;
      document.getElementById('year-badge').innerText = showFuture ? `ç¬¬ ${years} å¹´` : "æ­·å²å°¾ç«¯";

      const lookbackYears = parseInt(document.getElementById('entry-window').value)||0;

      // 1. å…ˆå–å¾—æ­·å²èµ°å‹¢æ•¸æ“š
      const hist = processHistoryPrincipal(p0, lookbackYears);
      
      // 2. âœ…ã€æ–°å¢é‚è¼¯ã€‘æ ¹æ“šæ­·å²æ•¸æ“šè¨ˆç®— CAGR ä¸¦è‡ªå‹•å¡«å…¥
      if(hist.labels.length > 1) {
          const startDate = parseDateLoose(hist.labels[0]);
          const endDate = hist.lastDate instanceof Date ? hist.lastDate : parseDateLoose(hist.labels[hist.labels.length-1]);
          
          let yearsDiff = 0;
          if(startDate && endDate) {
              const diffTime = endDate.getTime() - startDate.getTime();
              yearsDiff = diffTime / (1000 * 3600 * 24 * 365.25); // æ›ç®—æˆå¹´
          }

          if(yearsDiff > 0.1) { // è‡³å°‘è¦æœ‰0.1å¹´æ‰è¨ˆç®—
              // MOMO CAGR
              const mStart = hist.momoPrincipal[0];
              const mEnd = hist.momoPrincipal[hist.momoPrincipal.length-1];
              const mCagr = (Math.pow(mEnd / mStart, 1 / yearsDiff) - 1) * 100;
              
              // Bench CAGR
              const bStart = hist.benchPrincipal[0];
              const bEnd = hist.benchPrincipal[hist.benchPrincipal.length-1];
              const bCagr = (Math.pow(bEnd / bStart, 1 / yearsDiff) - 1) * 100;

              // å¡«å…¥ DOM
              const mInput = document.getElementById('momo-cagr');
              const bInput = document.getElementById('bench-cagr');
              if(mInput) mInput.value = mCagr.toFixed(2);
              if(bInput) bInput.value = bCagr.toFixed(2);
          }
      }

      // 3. é‡æ–°è®€å–å‰›å‰›å¡«å…¥çš„ CAGR (ç”¨æ–¼ç¹ªè£½æœªä¾†ç·š)
      const momoCagr = parseFloat(document.getElementById('momo-cagr').value)||0;
      const momoDiv  = parseFloat(document.getElementById('momo-div').value)||0;
      const benchCagr = parseFloat(document.getElementById('bench-cagr').value)||0;
      const benchDiv  = parseFloat(document.getElementById('bench-div').value)||0;

      const labels = hist.labels.slice();
      const mp = hist.momoPrincipal.slice();
      const bp = hist.benchPrincipal.slice();

      if(labels.length === 0) {
        return { labels:[], momoP:[0], benchP:[0], momoCumDiv:[0], benchCumDiv:[0], histLen:0, nowIdx:0, endIndex:0 };
      }

      const histLen = labels.length;
      const nowIdx = histLen - 1;

      const lastMp = mp[mp.length-1];
      const lastBp = bp[bp.length-1];

      if (showFuture) {
        const totalDays = years * 365;
        // ä½¿ç”¨å‰›å‰›è‡ªå‹•ç®—å‡ºä¾†çš„ CAGR é€²è¡Œæ¨æ¼”
        const dailyM = Math.pow(1 + momoCagr/100, 1/365) - 1;
        const dailyB = Math.pow(1 + benchCagr/100, 1/365) - 1;
        let currMp = lastMp, currBp = lastBp;
        const baseDt = hist.lastDate instanceof Date ? hist.lastDate : new Date();

        for(let i=1; i<=totalDays; i++){
          currMp *= (1 + dailyM); currBp *= (1 + dailyB);
          if(i % 5 === 0 || i === totalDays){
            const dt = new Date(baseDt.getFullYear(), baseDt.getMonth(), baseDt.getDate() + i);
            labels.push(dateKey(dt)); mp.push(currMp); bp.push(currBp);
          }
        }
      }

      const momoCumDiv = new Array(labels.length).fill(0);
      const benchCumDiv = new Array(labels.length).fill(0);
      let accM = 0, accB = 0;

      for(let i=1; i<labels.length; i++){
        let daysDiff = 1;
        const d1 = parseDateLoose(labels[i-1]);
        const d2 = parseDateLoose(labels[i]);
        if(d1 && d2) {
          const diff = (d2.getTime() - d1.getTime()) / (1000*60*60*24);
          if(Number.isFinite(diff) && diff > 0) daysDiff = diff;
        }

        accM += (p0 * (momoDiv/100) / 365) * daysDiff;
        accB += (p0 * (benchDiv/100) / 365) * daysDiff;

        momoCumDiv[i] = accM;
        benchCumDiv[i] = accB;
      }

      return { labels, histLen, nowIdx, momoP: mp, benchP: bp, momoCumDiv, benchCumDiv, endIndex: labels.length - 1 };
    }

    function initMainChart(){
      const ctx = document.getElementById("mainChart").getContext("2d");
      mainChart = new Chart(ctx, {
        type:'line',
        data:{ labels:[], datasets:[] },
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{ mode:'index', intersect:false },
          elements:{ point:{ radius:0, hoverRadius:5 } },
          layout:{ padding:{ bottom: 34, left: 6, right: 8, top: 6 } },
          scales:{
            x:{
              grid:{color:'rgba(255,255,255,0.05)'},
              ticks:{
                color:'#8aa0b8',
                maxTicksLimit: 9,
                autoSkip: true,
                padding: 16,
                maxRotation: 45,
                minRotation: 35
              }
            },
            y:{
              grid:{color:'rgba(255,255,255,0.06)'},
              ticks:{ color:'#8aa0b8', callback:(v)=> money(v).replace('$ ','$') }
            }
          },
          plugins:{
            legend:{ labels:{ color:'#c9d6e6', boxWidth:12, boxHeight:12, usePointStyle:true } },
            tooltip:{ callbacks:{ label:(c)=> `${c.dataset.label}ï¼š${money(c.raw)}` } }
          }
        }
      });
    }

    let leadAnim = null;
    function animateNum(el, from, to, ms=520){
      if(!el) return;
      if(leadAnim) cancelAnimationFrame(leadAnim);
      const t0 = performance.now();
      const d = to - from;
      const ease = x => 1 - Math.pow(1-x, 3);
      function tick(t){
        const p = Math.min(1, (t - t0)/ms);
        const v = from + d*ease(p);
        el.textContent = money(v);
        if(p<1) leadAnim = requestAnimationFrame(tick);
      }
      leadAnim = requestAnimationFrame(tick);
    }

    let lastLeadValue = 0;

    function setLeadCard(leadValue, benchTotal, principalDiff, divDiff){
      const elV = document.getElementById('lead-value');
      const elPct = document.getElementById('lead-pct');
      const elP = document.getElementById('lead-principal-diff');
      const elD = document.getElementById('lead-div-diff');

      animateNum(elV, lastLeadValue, leadValue, 560);
      lastLeadValue = leadValue;

      let pct = 0;
      if(benchTotal && Math.abs(benchTotal) > 1e-9) pct = (leadValue / benchTotal) * 100;

      if(elPct){
        elPct.textContent = `${pct>=0?'+':''}${pct.toFixed(1)}%`;
        elPct.classList.remove('positive','negative');
        if(pct >= 0) elPct.classList.add('positive');
        else elPct.classList.add('negative');
      }
      if(elP) elP.textContent = money(principalDiff);
      if(elD) elD.textContent = money(divDiff);
    }

    function setPctBadge(el, pct){
      if(!el) return;
      el.textContent = `${pct>=0?'+':''}${pct.toFixed(1)}%`;
      el.classList.remove('up','down');
      el.classList.add(pct>=0 ? 'up' : 'down');
    }

    function update(){
      renderSelectionPreview();
      updateSelectedCounts();

      const s = buildSeries();
      if(!mainChart) initMainChart();

      if(s.labels.length === 0 && mainChart) {
        mainChart.data.labels = [];
        mainChart.data.datasets = [];
        mainChart.update();
        setLeadCard(0, 1, 0, 0);
        setPctBadge(document.getElementById('momo-nav-pct'), 0);
        setPctBadge(document.getElementById('bench-nav-pct'), 0);
        document.getElementById('momo-mdd').innerText = "-0.0%";
        document.getElementById('bench-mdd').innerText = "-0.0%";
        document.getElementById('momo-div-amount').innerText = "$ 0";
        document.getElementById('bench-div-amount').innerText = "$ 0";
        return;
      }

      const ctx = mainChart.ctx;
      const gradientMomo = ctx.createLinearGradient(0, 0, 0, 400);
      gradientMomo.addColorStop(0, 'rgba(249, 226, 124, 0.35)');
      gradientMomo.addColorStop(1, 'rgba(249, 226, 124, 0.0)');

      const segmentStyle = { borderDash: c => (c.p0DataIndex > s.nowIdx ? [6,6] : undefined) };

      mainChart.data.labels = s.labels;

      mainChart.data.datasets = [
        {
          label:'MOMOç­–ç•¥ æ·¨å€¼(ä¸å«æ¯)',
          data: s.momoP,
          borderColor:'#F9E27C',
          backgroundColor: gradientMomo,
          borderWidth:3,
          cubicInterpolationMode:'monotone',
          tension:0.08,
          fill:1,
          segment: segmentStyle
        },
        {
          label:'æ¯”è¼ƒåŸºæº–(B) æ·¨å€¼(ä¸å«æ¯)',
          data: s.benchP,
          borderColor:'#38BDF8',
          backgroundColor:'rgba(56,189,248,0.06)',
          borderWidth:3,
          cubicInterpolationMode:'monotone',
          tension:0.08,
          fill:false,
          segment: segmentStyle
        },
        {
          label:'åˆå§‹æ°´ä½',
          data: s.labels.map(()=> s.momoP[0]),
          borderColor:'rgba(255,255,255,0.28)',
          borderWidth:1.5,
          tension:0,
          fill:false,
          borderDash:[3,6]
        }
      ];

      mainChart.update();

      const i = s.endIndex;

      const momoP = s.momoP[i] || 0;
      const benchP = s.benchP[i] || 0;
      const momoDiv = s.momoCumDiv[i] || 0;
      const benchDiv = s.benchCumDiv[i] || 0;

      const momoTotalWealth = momoP + momoDiv;
      const benchTotalWealth = benchP + benchDiv;

      document.getElementById('momo-total').innerText = money(momoTotalWealth);
      document.getElementById('bench-total').innerText = money(benchTotalWealth);

      document.getElementById('momo-principal').innerText = money(momoP);
      document.getElementById('bench-principal').innerText = money(benchP);

      if(document.getElementById('momo-acc-div'))
         document.getElementById('momo-acc-div').innerText = money(momoDiv);
      if(document.getElementById('bench-acc-div'))
         document.getElementById('bench-acc-div').innerText = money(benchDiv);

      document.getElementById('momo-div-amount').innerText = money(momoDiv);
      document.getElementById('bench-div-amount').innerText = money(benchDiv);

      const momoStart = s.momoP[0] || 1;
      const benchStart = s.benchP[0] || 1;
      const momoPct = ((momoP / momoStart) - 1) * 100;
      const benchPct = ((benchP / benchStart) - 1) * 100;

      setPctBadge(document.getElementById('momo-nav-pct'), momoPct);
      setPctBadge(document.getElementById('bench-nav-pct'), benchPct);

      const momoHistP = s.momoP.slice(0, s.histLen);
      const benchHistP = s.benchP.slice(0, s.histLen);

      const momoMDD = calculateMaxDrawdown(momoHistP);
      const benchMDD = calculateMaxDrawdown(benchHistP);

      document.getElementById('momo-mdd').innerText = `${momoMDD.toFixed(1)}%`;
      document.getElementById('bench-mdd').innerText = `${benchMDD.toFixed(1)}%`;

      const leadValue = momoTotalWealth - benchTotalWealth;
      const principalDiff = momoP - benchP;
      const divDiff = momoDiv - benchDiv;

      setLeadCard(leadValue, benchTotalWealth, principalDiff, divDiff);
    }

    async function exportImg() {
      const t = document.getElementById("report-capture");
      const originalScrollPos = window.scrollY;

      const safetyTimer = setTimeout(() => {
        console.warn("æˆªåœ–é€¾æ™‚ï¼Œå¼·åˆ¶é‚„åŸä»‹é¢");
        cleanupUI();
      }, 8000);

      function cleanupUI() {
        clearTimeout(safetyTimer);
        document.body.classList.remove('exporting');
        setTimeout(() => {
          try { if(mainChart) mainChart.resize(); } catch(e) { console.error("åœ–è¡¨é‡ç¹ªå¤±æ•—", e); }
          window.scrollTo(0, originalScrollPos);
        }, 100);
      }

      try {
        document.body.classList.add('exporting');
        await new Promise(r => setTimeout(r, 300));

        const c = await html2canvas(t, {
          backgroundColor: "#0A1221",
          scale: 2,
          useCORS: true,
          allowTaint: false,
          scrollY: 0,
          windowWidth: 1280,
          width: 1180
        });

        const a = document.createElement("a");
        a.download = "MOMO_Report_GS.png";
        a.href = c.toDataURL();
        a.click();

      } catch (err) {
        console.error("æˆªåœ–éç¨‹ç™¼ç”ŸéŒ¯èª¤:", err);
        alert("æˆªåœ–å¤±æ•—ï¼Œå¯èƒ½æ˜¯åœ–ç‰‡è·¨åŸŸæˆ–è¨˜æ†¶é«”ä¸è¶³å•é¡Œï¼Œè«‹é‡æ–°æ•´ç†å¾Œå†è©¦ã€‚");
      } finally {
        cleanupUI();
      }
    }

    window.onload = async () => {
      const img = document.getElementById("advisor-avatar");
      img.src = ADVISOR_AVATAR_URL;
      img.onerror = () => { img.src = "https://via.placeholder.com/60"; };

      new QRCode(document.getElementById("qrcode-target"), {
        text: LINE_QR_URL,
        width:44,
        height:44
      });

      fetchSheetData();
    };
  </script>
</body>
</html>
