<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOMOæ¬Šè­‰ç¯©é¸å™¨</title>

<!-- SheetJS -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/cpexcel.full.min.js"></script>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --deep:#0A1221;
    --card:#0C152A;
    --gold-grad:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%);
    --gold-soft:#E9D18A;
    --gold-solid:#E5C45A;
    --line:#E9D18A55;
    --muted:#9fb0d0;
    --red:#FF6B6B;
  }

  body{
    margin:0;background:var(--deep);color:#fff;
    font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
  }

  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .field{
    flex:1 1 220px;background:#0b1630;color:#fff;
    border:1px solid var(--line);border-radius:10px;
    padding:10px 12px;font-size:15px;outline:none;
  }

  label.chk{
    display:flex;align-items:center;gap:8px;
    background:#0b1630;border:1px solid var(--line);border-radius:10px;
    padding:10px 12px;cursor:pointer;
  }
  label.chk input{accent-color:#e0c669}

  .btn-link{
    background:var(--gold-grad);color:#000;border:none;border-radius:10px;
    padding:10px 16px;font-weight:700;cursor:pointer;
  }
  .btn-link[disabled]{opacity:.5;cursor:not-allowed}

  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;border:1px solid var(--line)}
  th,td{border:1px solid var(--line);padding:8px 6px;white-space:nowrap}
  th{position:sticky;top:0;background:#0f1b34;color:var(--gold-soft)}

  .tag{padding:2px 8px;border-radius:999px;font-size:11px}
  .tag.C{background:#E25A5A}
  .tag.P{background:#39C27A}

  .hint{font-size:12px;color:var(--muted)}

  .gold-text{
    background:var(--gold-grad);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    font-weight:700
  }
  .red-text{color:var(--red);font-weight:700}

  .exporting .gold-text{
    background:none !important;
    -webkit-text-fill-color:var(--gold-solid) !important;
    color:var(--gold-solid) !important;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h3 style="margin:0">MOMOæ¬Šè­‰ç¯©é¸å™¨</h3>
    <p id="meta" class="hint">æŒ‰ã€Œå¾ API å–å¾—è³‡æ–™ã€å–å¾—æœ€æ–°æ¬Šè­‰è³‡æ–™ã€‚</p>

    <div class="row">
      <button id="btnFetch" class="btn-link">å¾ API å–å¾—è³‡æ–™</button>
      <input id="fileInput" type="file" class="field" accept=".csv,.xlsx" />

      <input id="nameFilter" type="text" class="field" placeholder="åç¨±é—œéµå­—ï¼ˆç©ºç™½åˆ†éš”ï¼‰"/>
      <select id="selType" class="field" style="max-width:160px">
        <option value="C" selected>èªè³¼ (C)</option>
        <option value="P">èªå”® (P)</option>
      </select>

      <select id="selSortKey" class="field" style="max-width:260px">
        <option value="code">ä»£è™Ÿ</option>
        <option value="spread">åƒ¹å·®æ¯”</option>
        <option value="leverage">æ§“æ¡¿</option>
        <option value="s1" selected>S1 = åƒ¹å·®/æ§“æ¡¿</option>
        <option value="s2">S2 = åƒ¹å·®/æ§“æ¡¿/è¡Œä½¿</option>
      </select>

      <select id="selOrder" class="field" style="max-width:140px">
        <option value="asc">å‡å†ª</option>
        <option value="desc">é™å†ª</option>
      </select>

      <select id="selLimit" class="field" style="max-width:160px">
        <option value="5">5 åˆ—</option>
        <option value="10" selected>10 åˆ—</option>
        <option value="20">20 åˆ—</option>
        <option value="all">å…¨éƒ¨</option>
      </select>

      <label class="chk"><input type="checkbox" id="chkFilterZeroSpread" checked/>æ’é™¤åƒ¹å·®=0</label>
      <label class="chk"><input type="checkbox" id="chkHasIV" checked/>åªé¡¯ç¤ºæœ‰éš±æ³¢</label>

      <button id="btnExportPng" class="btn-link">åŒ¯å‡º PNG</button>
    </div>
  </div>

  <div id="resultCard" class="card" style="margin-top:12px;display:none">
    <div id="meta2" class="hint"></div>

    <div id="resultScroll" style="overflow:auto;max-height:70vh;margin-top:6px">
      <table id="resultTable">
        <thead>
          <tr>
            <th>ä»£è™Ÿ</th><th>åç¨±</th><th>CP</th><th>åƒ¹å·®æ¯”</th><th>æ§“æ¡¿</th>
            <th>è¡Œä½¿æ¯”ä¾‹</th><th>S1</th><th>S2</th><th>å‰©é¤˜å¤©æ•¸</th>
            <th>å±¥ç´„åƒ¹</th><th>æˆäº¤åƒ¹</th><th>éš±æ³¢</th><th>åƒ¹å…§å¤–</th><th>æµé€šæ¯”</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ========== é ç•™ï¼šæ”¹æˆä½  Render ä¸Šçš„å®Œæ•´ CSV API ========== */
const API_URL = "ğŸ‘‰ åœ¨é€™è£¡å¡«å…¥ Render CSV ç«¯é» ğŸ‘ˆ";

/* DOM */
const $=s=>document.querySelector(s);

/* æ•¸å­—å·¥å…· */
const fmtNum=(v,d=2)=>(v==null||!isFinite(v))?"â€”":(+v).toFixed(d);
const pct=(v,d=2)=>(v==null||!isFinite(v))?"â€”":(v*100).toFixed(d)+"%";

/* åŠå½¢è½‰æ› */
function toHalf(s){
  return String(s).replace(/[\uFF01-\uFF5E]/g, ch => 
    String.fromCharCode(ch.charCodeAt(0)-0xFEE0)
  );
}
function norm(s){ return toHalf(String(s||"")).trim().toLowerCase(); }

/* è§£æä¸Šå‚³ */
function sheetToArray(wb){
  const ws=wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws,{defval:""});
}

/* å…¨åŸŸ RAW */
let RAW=[];

/* è¦æ ¼åŒ–æ¬„ä½åç¨± */
function normalizeKey(k){
  if(!k) return "";
  let s=toHalf(k).replace(/\s+/g,"").replace(/\([^)]*\)/g,"").toLowerCase();
  return s;
}

/* æ¬„ä½æ˜ å°„ */
const MAP={
  "æ¬Šè­‰ä»£ç¢¼":"code",
  "ä»£ç¢¼":"code",
  "æ¬Šè­‰åç¨±":"name",
  "è²·è³£åƒ¹å·®æ¯”":"spread",
  "å¯¦è³ªæ§“æ¡¿":"lev",
  "è¡Œä½¿æ¯”ä¾‹":"exr",
  "è·åˆ°æœŸå¤©æ•¸":"days",
  "å±¥ç´„åƒ¹":"strike",
  "æ¬Šè­‰æˆäº¤åƒ¹":"price",
  "æˆäº¤åƒ¹":"price",
  "æˆäº¤åƒ¹éš±æ³¢":"iv",
  "éš±å«æ³¢å‹•ç‡":"iv",
  "åƒ¹å…§å¤–ç¨‹åº¦":"mny",
  "æµé€šåœ¨å¤–æ¯”ç‡":"flow"
};

function mapRow(row){
  const o={};
  for(const k in row){
    const nk = normalizeKey(k);
    if(!nk) continue;

    for(const raw in MAP){
      if(nk.includes(normalizeKey(raw))){
        o[MAP[raw]] = row[k];
      }
    }
  }
  return o;
}

/* å®Œæˆè¼‰å…¥ */
function done(arr,label){
  RAW = arr.map(mapRow);
  $("#meta").innerHTML = `è³‡æ–™ä¾†æºï¼š<b>${label}</b>ï¼å…± <b>${RAW.length}</b> ç­†`;

  recompute();
}

/* è¨ˆç®— */
function compute(){
  const want = $("#selType").value;
  const dropZero = $("#chkFilterZeroSpread").checked;
  const wantIV = $("#chkHasIV").checked;

  const qTokens = norm($("#nameFilter").value).split(/\s+/).filter(Boolean);

  const rows = RAW.map(r=>{
    const cp = (r.name||"").includes("å”®") ? "P" : "C";

    const spread = parseFloat(r.spread);
    const lev = parseFloat(r.lev);
    const exr = parseFloat(r.exr);
    const days = parseFloat(r.days);
    const iv = parseFloat(r.iv);

    const s1 = (spread && lev) ? spread/Math.abs(lev) : null;
    const s2 = (s1 && exr) ? s1/exr : null;

    return {
      code:r.code, name:r.name, cp,
      spread, lev, exr, s1, s2,
      days: isFinite(days)?days:null,
      strike:r.strike,
      price:r.price,
      iv, mny:r.mny, flow:r.flow,
      _n: norm(r.name)
    };
  }).filter(r=>{
    if(r.cp !== want) return false;
    if(dropZero && r.spread===0) return false;
    if(wantIV && !isFinite(r.iv)) return false;

    for(const t of qTokens){ if(!r._n.includes(t)) return false; }
    return true;
  });

  /* æ’åº */
  const key=$("#selSortKey").value;
  const dir=$("#selOrder").value==="desc"?-1:1;

  rows.sort((a,b)=>{
    const va=a[key], vb=b[key];
    if(va==null) return 1;
    if(vb==null) return -1;
    return (va>vb?1:(va<vb?-1:0))*dir;
  });

  return rows;
}

/* æ¸²æŸ“ */
function render(rows){
  $("#resultCard").style.display="block";

  const limit = $("#selLimit").value==="all"
    ? rows.length
    : parseInt($("#selLimit").value,10);

  const list = rows.slice(0,limit);

  $("#meta2").innerHTML = `é¡¯ç¤º ${list.length} / ${rows.length} ç­†`;

  const tb=$("#tbody");
  tb.innerHTML="";

  list.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td><b>${r.code}</b></td>
      <td>${r.name}</td>
      <td><span class="tag ${r.cp}">${r.cp}</span></td>
      <td>${fmtNum(r.spread,3)}</td>
      <td>${fmtNum(r.lev,3)}</td>
      <td>${fmtNum(r.exr,3)}</td>
      <td>${pct(r.s1,2)}</td>
      <td>${pct(r.s2,2)}</td>
      <td>${r.days??"â€”"}</td>
      <td>${r.strike??""}</td>
      <td>${fmtNum(r.price,3)}</td>
      <td>${fmtNum(r.iv,3)}</td>
      <td>${r.mny??""}</td>
      <td>${r.flow??""}</td>
    `;
    tb.appendChild(tr);
  });
}

let tm=null;
function recompute(){
  clearTimeout(tm);
  tm=setTimeout(()=>{
    render(compute());
  },100);
}

/* ç›£è½é …ç›® */
["nameFilter","selType","selSortKey","selOrder","selLimit","chkFilterZeroSpread","chkHasIV"]
.forEach(id=>{
  $(`#${id}`).addEventListener("input", recompute);
  $(`#${id}`).addEventListener("change", recompute);
});

/* åŒ¯å‡º PNG */
$("#btnExportPng").addEventListener("click",async()=>{
  const wrap = $("#resultCard");
  document.body.classList.add("exporting");

  const canvas = await html2canvas(wrap,{scale:2});
  const link = document.createElement("a");

  link.download = "momo_warrant.png";
  link.href = canvas.toDataURL("image/png");
  link.click();

  document.body.classList.remove("exporting");
});

/* å¾ API æŠ“å– */
$("#btnFetch").addEventListener("click",async()=>{
  const btn=$("#btnFetch");
  const old=btn.textContent;

  btn.disabled=true;
  btn.textContent="æŠ“å–ä¸­â€¦";

  try{
    const res = await fetch(API_URL,{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);

    const csv = await res.text();
    const wb = XLSX.read(csv,{type:"string"});
    const arr = sheetToArray(wb);

    if(!arr.length) throw new Error("CSV ç„¡è³‡æ–™");

    done(arr,"APIï¼ˆRenderï¼‰");

  }catch(err){
    console.error(err);
    alert("æŠ“å–å¤±æ•—ï¼š"+err.message);
  }finally{
    btn.disabled=false;
    btn.textContent=old;
  }
});

/* åˆå§‹åŒ– */
document.addEventListener("DOMContentLoaded",()=>recompute());
</script>

</body>
</html>
