/**
 * ==============================================================================
 * MOMO æ¬Šè­‰è‡ªå‹•åŒ–ç›£æ¸¬ç³»çµ± - å¾Œç«¯æ ¸å¿ƒ (ç²¾ç°¡ä¸€åˆ— + æ•ˆèƒ½å„ªåŒ–ç‰ˆ)
 * ==============================================================================
 * åŠŸèƒ½ 1: æ¯æ—¥è‡ªå‹•æŠ“å–ï¼Œå¼·åˆ¶æ¯æª”æ¬Šè­‰åœ¨è©¦ç®—è¡¨ä¸­ã€Œåƒ…ä¿ç•™ 1 ç­†æœ€æ–°ç´€éŒ„ã€ã€‚
 * åŠŸèƒ½ 2: æ›´æ–°æ™‚è‡ªå‹•ç´€éŒ„ã€Œæ˜¨æ—¥éš±æ³¢ã€ï¼Œä»¥ç²¾æº–ç›£æ§éš±æ³¢å·® (IV Delta)ã€‚
 * åŠŸèƒ½ 3: åš´æ ¼éæ¿¾åƒåœ¾æ•¸æ“šï¼šå‰”é™¤å¤©æ•¸ < 60å¤©ã€S2 > 1500% çš„æ¨™çš„ã€‚
 * åŠŸèƒ½ 4: æ’åºé‚è¼¯ï¼šå…¨è¡¨ä¾ S1 (CPå€¼) é€²è¡Œå‡å†ªæ’åºï¼Œä¸¦ç™¼é€ Telegram å ±å‘Šã€‚
 * ==============================================================================
 */

const SHEET_ID = "1hyH_AhuFVgWtQawHKi9JI-JGcFf0Q5VZc03R8giaDs4";
const TELEGRAM_TOKEN = "8308620447:AAF5Qzb85Et4d2RdpioPCx3OkvaBhYDENFw";
const TELEGRAM_CHAT_ID = "7953758794";

// ç‰¹å®šè§€å¯Ÿæ¨™çš„ (ä»£è™Ÿæˆ–åç¨±)
const WATCHLIST = ["å°ç©é›»", "2330", "é´»æµ·", "2317", "è¯ç™¼ç§‘", "2454", "å»£é”", "2382", "æ¬£èˆˆ", "3037"]; 

// ç¯©é¸é–€æª»
const GOLDEN_S1_LIMIT = 0.001; 
const S2_MAX_LIMIT = 15.0;     // S2 > 1500% å‰ƒé™¤
const MIN_DAYS = 60;           // å¤©æ•¸ < 60 å‰ƒé™¤

/**
 * ç¶²é å‘¼å« API å…¥å£
 */
function doGet(e) {
  try {
    const csvData = fetchWarrantDataFromYuanta();
    return ContentService.createTextOutput(csvData).setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Error: " + err.toString());
  }
}

/**
 * æ¯æ—¥ä»»å‹™ï¼šæ ¸å¿ƒè‡ªå‹•åŒ–ç´€éŒ„èˆ‡ Telegram å›å ±
 */
function dailyWarrantJob() {
  const csvData = fetchWarrantDataFromYuanta();
  const allData = parseCSVToObjects(csvData);
  
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName("History") || ss.insertSheet("History");
  const today = Utilities.formatDate(new Date(), "GMT+8", "yyyy-MM-dd");

  const existingRows = sheet.getDataRange().getValues();
  const historyMap = new Map();
  
  // å»ºç«‹ç¾æœ‰è³‡æ–™ Map (ä»£è™Ÿ -> è©²è¡Œæ•¸æ“š)
  for (let i = 1; i < existingRows.length; i++) {
    const code = existingRows[i][1].toString().trim();
    historyMap.set(code, existingRows[i]);
  }

  let goldenList = [];
  let watchlistReport = [];
  const updatedDataMap = new Map();

  allData.forEach(r => {
    // åš´æ ¼éæ¿¾ï¼šç„¡æ•ˆæ•¸æ“šã€å¤©æ•¸ä¸è¶³ã€æ€§åƒ¹æ¯”æ¥µä½
    if (r.iv <= 0.1 || r.leverage <= 0.1 || r.spread <= 0 || r.days < MIN_DAYS) return;
    const s1 = r.spread / Math.abs(r.leverage);
    const s2 = s1 / r.exercise;
    if (s2 > S2_MAX_LIMIT) return;

    const isWatch = WATCHLIST.some(tag => r.name.includes(tag) || r.code.includes(tag));
    const isGolden = (s1 < GOLDEN_S1_LIMIT && (s2 * 100) < 150);

    if (isWatch || isGolden) {
      const oldRecord = historyMap.get(r.code);
      let lastIv = null;

      if (oldRecord) {
        // å¦‚æœèˆŠç´€éŒ„æ˜¯ä»Šå¤©çš„ï¼Œå˜—è©¦ç¶­æŒåŸæœ¬çš„æ˜¨æ—¥éš±æ³¢ï¼›è‹¥éä»Šå¤©ï¼Œå‰‡ä»Šæ—¥éš±æ³¢è®Šæ˜¨æ—¥éš±æ³¢
        lastIv = (oldRecord[0] === today) ? oldRecord[4] : oldRecord[3];
      }

      const ivDelta = (lastIv && !isNaN(lastIv)) ? (r.iv - lastIv).toFixed(2) : "New";
      const newRow = [
        today, r.code, r.name, r.iv, lastIv || "â€”", ivDelta, 
        (s1*100).toFixed(2) + "%", (s2*100).toFixed(2) + "%", r.days
      ];
      
      updatedDataMap.set(r.code, newRow);

      if (isGolden) goldenList.push({...r, s1Value: s1});
      if (isWatch) watchlistReport.push({...r, ivDelta, s1Value: s1});
    }
  });

  // å…¨åŸŸä¾ S1 æ’åº (æœ€ä½æœ€åˆ’ç®—æ’ç¬¬ä¸€)
  let finalRows = Array.from(updatedDataMap.values()).sort((a, b) => {
    return parseFloat(a[6]) - parseFloat(b[6]);
  });

  // è¦†å¯«è©¦ç®—è¡¨
  sheet.clearContents();
  const header = ["æ—¥æœŸ", "ä»£è™Ÿ", "åç¨±", "ä»Šæ—¥éš±æ³¢", "æ˜¨æ—¥éš±æ³¢", "éš±æ³¢å·®", "S1", "S2", "å¤©æ•¸"];
  sheet.getRange(1, 1, 1, header.length).setValues([header]);
  if (finalRows.length > 0) {
    sheet.getRange(2, 1, finalRows.length, header.length).setValues(finalRows);
  }

  sendTelegramReport(goldenList, watchlistReport);
}

/**
 * æ‰‹å‹•åŸ·è¡Œå·¥å…·ï¼šä¸€éµæ•´ç†ç¾æœ‰æ··äº‚è³‡æ–™ç‚ºã€Œä¸€æª”ä¸€åˆ—ã€
 */
function reorganizeHistorySheet() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName("History");
  if (!sheet) return;
  const rawData = sheet.getDataRange().getValues();
  const codeMap = new Map();
  for (let i = 1; i < rawData.length; i++) {
    const row = rawData[i];
    const code = row[1].toString().trim();
    const s2Val = parseFloat(row[7]) / 100 || 0;
    const days = parseInt(row[8]) || 0;
    if (days >= MIN_DAYS && s2Val <= S2_MAX_LIMIT) codeMap.set(code, row);
  }
  const sorted = Array.from(codeMap.values()).sort((a, b) => parseFloat(a[6]) - parseFloat(b[6]));
  sheet.clearContents();
  sheet.getRange(1, 1, 1, 9).setValues([["æ—¥æœŸ", "ä»£è™Ÿ", "åç¨±", "ä»Šæ—¥éš±æ³¢", "æ˜¨æ—¥éš±æ³¢", "éš±æ³¢å·®", "S1", "S2", "å¤©æ•¸"]]);
  if (sorted.length > 0) sheet.getRange(2, 1, sorted.length, 9).setValues(sorted);
}

function sendTelegramReport(goldens, watches) {
  let msg = `ğŸ“… <b>MOMO æ¬Šè­‰æ—¥å ± (${Utilities.formatDate(new Date(), "GMT+8", "MM/dd")})</b>\n\n`;
  msg += `ğŸ† <b>ç²¾é¸é»ƒé‡‘æ¬Šè­‰ (S1 æœ€å„ªæ’åº)</b>\n`;
  if (goldens.length === 0) {
    msg += "â€¢ ä»Šæ—¥ç„¡ç¬¦åˆæ¨™çš„\n";
  } else {
    goldens.sort((a,b) => a.s1Value - b.s1Value).slice(0, 8).forEach(g => {
      msg += `â€¢ <a href="https://www.wantgoo.com/stock/warrant/${g.code}">${g.code}</a> ${escapeHtml(g.name)}\n  (S1: ${(g.s1Value*100).toFixed(2)}% | ${escapeHtml(g.moneyness)})\n`;
    });
  }
  msg += `\nğŸ” <b>æ¨™çš„éš±æ³¢ç›£æ§ (IV Delta)</b>\n`;
  WATCHLIST.forEach(target => {
    const matched = watches.filter(w => w.name.includes(target) || w.code === target);
    if (matched.length > 0) {
      msg += `<b>[${escapeHtml(target)}]</b>\n`;
      matched.sort((a,b) => a.s1Value - b.s1Value).slice(0, 2).forEach(m => {
        const sign = m.ivDelta > 0 ? "ğŸ“ˆ +" : (m.ivDelta < 0 ? "ğŸ“‰ " : "â– ");
        msg += `  ${m.code}: IV ${m.iv} (${sign}${m.ivDelta} | ${escapeHtml(m.moneyness)})\n`;
      });
    }
  });

  UrlFetchApp.fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
    "method": "post", "contentType": "application/json",
    "payload": JSON.stringify({ "chat_id": TELEGRAM_CHAT_ID, "text": msg, "parse_mode": "HTML", "disable_web_page_preview": true }),
    "muteHttpExceptions": true
  });
}

function fetchWarrantDataFromYuanta() {
  const targetUrl = 'https://www.warrantwin.com.tw/eyuanta/ws/GetWarData.ashx';
  const payload = {
    format: "CSV", factor: {
      columns: ["FLD_WAR_ID", "FLD_WAR_NM", "FLD_WAR_TXN_PRICE", "FLD_WAR_UP_DN", "FLD_WAR_UP_DN_RATE", "FLD_WAR_TXN_VOLUME", "FLD_N_STRIKE_PRC", "FLD_N_UND_CONVER", "FLD_PERIOD", "FLD_IN_OUT", "FLD_BUY_SELL_RATE", "FLD_LEVERAGE", "FLD_IV_CLOSE_PRICE"],
      condition: [{ "field": "FLD_WAR_TYPE", "values": ["1", "2"] }]
    }, pagination: { "page": "1" }
  };
  const response = UrlFetchApp.fetch(targetUrl, { 'method': 'post', 'payload': { 'data': JSON.stringify(payload) } });
  return Utilities.newBlob(response.getBlob().getBytes(), 'text/csv', 'big5').getDataAsString('big5');
}

function parseCSVToObjects(csv) {
  const lines = csv.split("\n");
  return lines.slice(1).map(line => {
    const c = line.split(",").map(cell => cell.replace(/"/g, "").trim());
    if (c.length < 13) return null;
    return {
      code: c[0], name: c[1], exercise: parseFloat(c[7]) || 0, days: parseInt(c[8]) || 0,
      moneyness: c[9], spread: parseFloat(c[10]) || 0, leverage: parseFloat(c[11]) || 0, iv: parseFloat(c[12]) || 0
    };
  }).filter(Boolean);
}

function escapeHtml(text) {
  return text ? text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
}
