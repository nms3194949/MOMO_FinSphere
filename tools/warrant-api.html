<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MOMO權證篩選器</title>

<!-- SheetJS -->
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/cpexcel.full.min.js"></script>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root{
    --deep:#0A1221;
    --card:#0C152A;
    --gold-grad:linear-gradient(90deg,#F9E27C 0%,#D9B84B 50%,#B88A1E 100%);
    --gold-soft:#E9D18A;
    --gold-solid:#E5C45A;
    --line:#E9D18A55;
    --muted:#9fb0d0;
    --red:#FF6B6B;
  }

  body{margin:0;background:var(--deep);color:#fff;font-family:"Noto Sans TC","PingFang TC","Microsoft JhengHei",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  .field{
    flex:1 1 220px;background:#0b1630;color:#fff;
    border:1px solid var(--line);border-radius:10px;padding:10px 12px;font-size:15px;outline:none;
  }

  label.chk{display:flex;align-items:center;gap:8px;background:#0b1630;border:1px solid var(--line);border-radius:10px;padding:10px 12px;cursor:pointer;}
  label.chk input{accent-color:#e0c669}

  .btn-link{
    background:var(--gold-grad);color:#000;border:none;border-radius:10px;
    padding:10px 16px;font-weight:700;cursor:pointer;
  }
  .btn-link[disabled]{opacity:.5;cursor:not-allowed}

  table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;border:1px solid var(--line)}
  th,td{border:1px solid var(--line);padding:8px 6px;white-space:nowrap}
  th{position:sticky;top:0;background:#0f1b34;color:var(--gold-soft)}

  .tag{padding:2px 8px;border-radius:999px;font-size:11px}
  .tag.C{background:#E25A5A}
  .tag.P{background:#39C27A}

  .hint{font-size:12px;color:var(--muted)}

  .gold-text{
    background:var(--gold-grad);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;font-weight:700
  }
  .red-text{color:var(--red);font-weight:700}

  .exporting .gold-text{
    background:none !important;
    -webkit-text-fill-color:var(--gold-solid) !important;
    color:var(--gold-solid) !important;
  }
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h3 style="margin:0">MOMO權證篩選器</h3>
    <p id="meta" class="hint">按「從 API 取得資料」取得最新權證資料。</p>

    <div class="row">
      <button id="btnFetch" class="btn-link">從 API 取得資料</button>
      <input id="fileInput" type="file" class="field" accept=".csv,.xlsx" />
      <input id="nameFilter" type="text" class="field" placeholder="名稱關鍵字（空白分隔）"/>

      <select id="selType" class="field" style="max-width:160px">
        <option value="C" selected>認購 (C)</option>
        <option value="P">認售 (P)</option>
      </select>

      <select id="selSortKey" class="field" style="max-width:260px">
        <option value="code">代號</option>
        <option value="spread">價差比</option>
        <option value="leverage">槓桿</option>
        <option value="s1" selected>S1 = 價差/槓桿</option>
        <option value="s2">S2 = 價差/槓桿/行使</option>
      </select>

      <select id="selOrder" class="field" style="max-width:140px">
        <option value="asc">升冪</option>
        <option value="desc">降冪</option>
      </select>

      <select id="selLimit" class="field" style="max-width:160px">
        <option value="5">5 列</option>
        <option value="10" selected>10 列</option>
        <option value="20">20 列</option>
        <option value="all">全部</option>
      </select>

      <label class="chk"><input type="checkbox" id="chkFilterZeroSpread" checked/>排除價差=0</label>
      <label class="chk"><input type="checkbox" id="chkHasIV" checked/>只顯示有隱波</label>

      <button id="btnExportPng" class="btn-link">匯出 PNG</button>
    </div>
  </div>

  <div id="resultCard" class="card" style="margin-top:12px;display:none">
    <div id="meta2" class="hint"></div>

    <div id="resultScroll" style="overflow:auto;max-height:70vh;margin-top:6px">
      <table id="resultTable">
        <thead>
          <tr>
            <th>代號</th><th>名稱</th><th>CP</th><th>價差比</th><th>槓桿</th>
            <th>行使比例</th><th>S1</th><th>S2</th><th>剩餘天數</th>
            <th>履約價</th><th>成交價</th><th>隱波</th>
            <th>價內外</th><th>流通比</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ■■■■■ 已依你要求修改：固定使用 Render 主網址 ■■■■■ */
const API_URL = "https://warrant-render-proxy-1.onrender.com";

/* DOM */
const $=s=>document.querySelector(s);

/* 工具 */
const fmtNum=(v,d=2)=>(!isFinite(v))?"—":(+v).toFixed(d);
const pct=(v,d=2)=>(!isFinite(v))?"—":(v*100).toFixed(d)+"%";

function toHalf(s){return String(s).replace(/[\uFF01-\uFF5E]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0));}
function norm(s){return toHalf(String(s||"")).trim().toLowerCase();}

function sheetToArray(wb){
  const ws=wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws,{defval:""});
}

let RAW=[];

/* 欄位映射 */
const MAP={
  "權證代碼":"code","代碼":"code",
  "權證名稱":"name","名稱":"name",
  "買賣價差比":"spread",
  "實質槓桿":"lev","槓桿":"lev",
  "行使比例":"exr",
  "距到期天數":"days",
  "履約價":"strike",
  "權證成交價":"price","成交價":"price",
  "成交價隱波":"iv","隱含波動率":"iv",
  "價內外程度":"mny",
  "流通在外比率":"flow"
};

function normalizeKey(k){
  return toHalf(k).replace(/\s+/g,"").replace(/\([^)]*\)/g,"").toLowerCase();
}

function mapRow(row){
  const o={};
  for(const k in row){
    const nk=normalizeKey(k);
    for(const raw in MAP){
      if(nk.includes(normalizeKey(raw))) o[MAP[raw]]=row[k];
    }
  }
  return o;
}

function done(arr,label){
  RAW = arr.map(mapRow);
  $("#meta").innerHTML=`資料來源：<b>${label}</b>／共 <b>${RAW.length}</b> 筆`;
  recompute();
}

function compute(){
  const want=$("#selType").value;
  const dropZero=$("#chkFilterZeroSpread").checked;
  const wantIV=$("#chkHasIV").checked;
  const qTokens=norm($("#nameFilter").value).split(/\s+/).filter(Boolean);

  const rows = RAW.map(r=>{
    const cp = (r.name||"").includes("售") ? "P" : "C";

    const spread=parseFloat(r.spread);
    const lev=parseFloat(r.lev);
    const exr=parseFloat(r.exr);
    const days=parseFloat(r.days);
    const iv=parseFloat(r.iv);

    const s1=(spread&&lev)?spread/Math.abs(lev):null;
    const s2=(s1&&exr)?s1/exr:null;

    return{
      code:r.code,name:r.name,cp,
      spread,lev,exr,s1,s2,
      days:isFinite(days)?days:null,
      strike:r.strike,price:r.price,iv,
      mny:r.mny,flow:r.flow,
      _n:norm(r.name)
    };
  }).filter(r=>{
    if(r.cp!==want) return false;
    if(dropZero && r.spread===0) return false;
    if(wantIV && !isFinite(r.iv)) return false;
    for(const t of qTokens){ if(!r._n.includes(t)) return false; }
    return true;
  });

  const key=$("#selSortKey").value;
  const dir=$("#selOrder").value==="desc"?-1:1;

  rows.sort((a,b)=>{
    const va=a[key], vb=b[key];
    if(va==null) return 1;
    if(vb==null) return -1;
    return (va>vb?1:(va<vb?-1:0))*dir;
  });

  return rows;
}

function render(rows){
  $("#resultCard").style.display="block";

  const limit = $("#selLimit").value==="all"
    ? rows.length
    : parseInt($("#selLimit").value,10);

  const list = rows.slice(0,limit);
  $("#meta2").innerHTML=`顯示 ${list.length} / ${rows.length} 筆`;

  const tb=$("#tbody");
  tb.innerHTML="";

  list.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>${r.code}</b></td>
      <td>${r.name}</td>
      <td><span class="tag ${r.cp}">${r.cp}</span></td>
      <td>${fmtNum(r.spread,3)}</td>
      <td>${fmtNum(r.lev,3)}</td>
      <td>${fmtNum(r.exr,3)}</td>
      <td>${pct(r.s1,2)}</td>
      <td>${pct(r.s2,2)}</td>
      <td>${r.days??"—"}</td>
      <td>${r.strike??""}</td>
      <td>${fmtNum(r.price,3)}</td>
      <td>${fmtNum(r.iv,3)}</td>
      <td>${r.mny??""}</td>
      <td>${r.flow??""}</td>
    `;
    tb.appendChild(tr);
  });
}

let tm=null;
function recompute(){
  clearTimeout(tm);
  tm=setTimeout(()=>render(compute()),100);
}

["nameFilter","selType","selSortKey","selOrder","selLimit","chkFilterZeroSpread","chkHasIV"]
.forEach(id=>{
  $(`#${id}`).addEventListener("input",recompute);
  $(`#${id}`).addEventListener("change",recompute);
});

$("#btnExportPng").addEventListener("click",async()=>{
  const wrap=$("#resultCard");
  document.body.classList.add("exporting");

  const canvas=await html2canvas(wrap,{scale:2});
  const link=document.createElement("a");
  link.download="momo_warrant.png";
  link.href=canvas.toDataURL("image/png");
  link.click();

  document.body.classList.remove("exporting");
});

/* ★ 從 Render 抓取資料 ★ */
$("#btnFetch").addEventListener("click",async()=>{
  const btn=$("#btnFetch");
  const old=btn.textContent;

  btn.disabled=true;
  btn.textContent="抓取中…";

  try{
    const res = await fetch(API_URL,{cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);

    const csv = await res.text();
    const wb = XLSX.read(csv,{type:"string"});
    const arr = sheetToArray(wb);

    if(!arr.length) throw new Error("CSV 無資料");

    done(arr,"API（Render）");

  }catch(err){
    alert("抓取失敗："+err.message);
    console.error(err);
  }finally{
    btn.disabled=false;
    btn.textContent=old;
  }
});

document.addEventListener("DOMContentLoaded",()=>recompute());
</script>

</body>
</html>
