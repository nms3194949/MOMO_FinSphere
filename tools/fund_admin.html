<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘æˆ°æƒ…å®¤ - ä¸­å¤®æ§åˆ¶å°</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2563eb; --success: #059669; --bg: #f1f5f9; --text: #1e293b; --info-bg: #eff6ff; --info-text: #1e40af; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 850px; margin: 0 auto; }
        
        h1 { text-align: center; color: #334155; margin-bottom: 20px; font-size: 1.8rem; }
        
        /* SOP èªªæ˜å€å¡Šæ¨£å¼ */
        .sop-card {
            background: white; border-radius: 12px; padding: 25px; margin-bottom: 30px; 
            border-left: 5px solid var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .sop-title { font-size: 1.2rem; font-weight: bold; color: var(--text); margin-bottom: 15px; display: flex; align-items: center; }
        .sop-list { margin: 0; padding-left: 25px; color: #475569; line-height: 1.8; }
        .sop-list li { margin-bottom: 8px; }
        .highlight { color: #d97706; font-weight: bold; background: #fffbeb; padding: 2px 6px; border-radius: 4px; }
        .link-text { color: var(--primary); text-decoration: none; font-weight: bold; cursor: pointer; }
        
        /* åŠŸèƒ½å¡ç‰‡æ¨£å¼ */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .card-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; color: #334155; }
        .hint { font-size: 0.9rem; color: #64748b; margin-bottom: 15px; display: block; line-height: 1.5; }
        
        /* æŒ‰éˆ•èˆ‡è¼¸å…¥æ¡† */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        .btn-update { background: var(--primary); }
        .btn-update:hover { background: #1d4ed8; }
        .btn-upload { background: var(--success); }
        .btn-upload:hover { background: #047857; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        
        input[type="file"] { display: block; width: 100%; padding: 12px; margin-bottom: 15px; border: 2px dashed #cbd5e1; border-radius: 8px; background: #f8fafc; cursor: pointer; }
        input[type="file"]:hover { border-color: var(--success); background: #f0fdf4; }

        /* ç‹€æ…‹é¡¯ç¤º */
        .status-box { margin-top: 15px; padding: 15px; border-radius: 8px; font-size: 0.9rem; white-space: pre-wrap; display: none; line-height: 1.6; }
        .status-loading { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .status-success { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .status-error { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

        /* åˆ†éš”ç·š */
        hr { border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0; }
    </style>
</head>
<body>

<h1>ğŸ›ï¸ åŸºé‡‘è³‡æ–™åº«æ§åˆ¶å°</h1>

<div class="sop-card">
    <div class="sop-title">ğŸ“˜ æ–°å¢åŸºé‡‘æ¨™æº–æµç¨‹ (SOP)</div>
    <ol class="sop-list">
        <li>
            <b>è¨­å®šè³‡æ–™ï¼š</b>é–‹å•Ÿ <a href="https://docs.google.com/spreadsheets/d/1hnk0iEVQv9NdXns_PZ0IGdc3WgkbbqoJs0Zw1EvLWl4/edit#gid=0" target="_blank" class="link-text">Google Sheet</a> çš„ <span class="highlight">Config</span> åˆ†é ï¼Œåœ¨æœ€ä¸‹æ–¹æ–°å¢ä¸€è¡Œï¼Œå¡«å…¥è©²åŸºé‡‘çš„ <b>ä»£è™Ÿã€åç¨±ã€ç¶²å€</b>ã€‚
        </li>
        <li>
            <b>æº–å‚™èˆŠæª”ï¼š</b>æ•´ç†ä¸€å€‹ Excel æª”æ¡ˆï¼Œå°‡è©²åŸºé‡‘éå»çš„æ­·å²æ·¨å€¼è²¼ä¸Šå»ã€‚<br>
            âš ï¸ <b>é‡è¦è¦å‰‡ï¼š</b>
            <ul>
                <li>å·¥ä½œè¡¨åç¨± (Sheet Name) å¿…é ˆç­‰æ–¼ <span class="highlight">åŸºé‡‘åç¨±</span>ã€‚</li>
                <li>å…§å®¹æ ¼å¼ï¼š<b>Aæ¬„=æ—¥æœŸ</b>ï¼Œ<b>Bæ¬„=æ·¨å€¼</b>ã€‚</li>
            </ul>
        </li>
        <li>
            <b>åŸ·è¡Œä¸Šå‚³ï¼š</b>ä½¿ç”¨æœ¬ç¶²é ä¸‹æ–¹çš„ <b>ã€ŒåŠŸèƒ½ Bã€</b>ï¼Œé¸å–è©² Excel æª”æ¡ˆä¸¦ä¸Šå‚³ã€‚ç³»çµ±æœƒè‡ªå‹•å°‡èˆŠè³‡æ–™å¯«å…¥é›²ç«¯è³‡æ–™åº«ã€‚
        </li>
        <li>
            <b>å®Œæˆï¼š</b>ä¹‹å¾Œæ¯æ—¥çš„è‡ªå‹•æ’ç¨‹å°±æœƒæ¥æ‰‹æ›´æ–°é€™æ”¯æ–°åŸºé‡‘ã€‚
        </li>
    </ol>
</div>

<div class="card">
    <div class="card-header">ğŸš€ åŠŸèƒ½ Aï¼šæ‰‹å‹•è§¸ç™¼æ›´æ–°</div>
    <span class="hint">
        é€™æ˜¯æ‚¨çš„ã€Œé™æ§å™¨ã€ã€‚é»æ“Šå¾Œæœƒå‘½ä»¤ Google å¾Œç«¯ç«‹å³åŸ·è¡Œä¸€æ¬¡ã€Œæ¯æ—¥æ›´æ–°æµç¨‹ã€ (æŠ“å–æ‰€æœ‰åŸºé‡‘æœ€è¿‘ 30 å¤©æ·¨å€¼ä¸¦åˆä½µ)ã€‚<br>
        <i>(å¹³å¸¸æ¯æ—¥ä¸‹åˆ 5-6 é»æœƒè‡ªå‹•åŸ·è¡Œï¼Œç„¡éœ€æ‰‹å‹•æŒ‰)</i>
    </span>
    <button id="btn-manual" class="btn btn-update">ç«‹å³åŸ·è¡Œæ›´æ–°</button>
    <div id="status-manual" class="status-box"></div>
</div>

<div class="card">
    <div class="card-header">ğŸ“‚ åŠŸèƒ½ Bï¼šä¸Šå‚³/è£œé½Š æ­·å²è³‡æ–™</div>
    <span class="hint">
        ç•¶æ‚¨<b>æ–°å¢åŸºé‡‘</b>æˆ–<b>æƒ³è£œé½ŠèˆŠè³‡æ–™</b>æ™‚ä½¿ç”¨ã€‚<br>
        è«‹é¸æ“‡ç¬¦åˆ SOP æ ¼å¼è¦æ±‚çš„ Excel æª”æ¡ˆï¼š
    </span>
    <input type="file" id="file-input" accept=".xlsx, .xls">
    <button id="btn-upload" class="btn btn-upload" disabled>è®€å– Excel ä¸¦å¯«å…¥è³‡æ–™åº«</button>
    <div id="status-upload" class="status-box"></div>
</div>

<div style="text-align: center; margin-top: 30px; color: #94a3b8; font-size: 0.8rem;">
    Fund Manager System V26 â€¢ Powered by Google Apps Script
</div>

<script>
    // â–¼â–¼â–¼ è¨­å®šå€ â–¼â–¼â–¼
    const API_URL = "https://script.google.com/macros/s/AKfycbwO6P2z-o4sfG0daX5aGUY0JdSiBQUA_rj_oKdyuhoGRoClJe3PDir8VxbEiHaf9egIxA/exec";
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    // --- åŠŸèƒ½ A: æ‰‹å‹•æ›´æ–° ---
    const btnManual = document.getElementById('btn-manual');
    const statusManual = document.getElementById('status-manual');

    btnManual.addEventListener('click', async () => {
        btnManual.disabled = true;
        btnManual.innerText = "â³ æ­£åœ¨é€£ç·šå¾Œç«¯æ›´æ–°...";
        showStatus(statusManual, "ç³»çµ±æ­£åœ¨æŠ“å–æœ€æ–°æ·¨å€¼ä¸¦åˆä½µï¼Œè«‹ç¨å€™ç´„ 20-40 ç§’...", "loading");

        try {
            const response = await fetch(`${API_URL}?op=manual_update`);
            const json = await response.json();

            if (json.status === "success") {
                showStatus(statusManual, "âœ… " + json.message + "\n(è©³ç´°å…§å®¹è«‹æŸ¥çœ‹æ‚¨çš„ Email é€šçŸ¥)", "success");
                btnManual.innerText = "æ›´æ–°å®Œæˆ";
            } else {
                throw new Error(json.message || "æœªçŸ¥éŒ¯èª¤");
            }
        } catch (err) {
            showStatus(statusManual, "âŒ æ›´æ–°å¤±æ•—: " + err.message, "error");
            btnManual.innerText = "é‡è©¦";
            btnManual.disabled = false;
        }
    });

    // --- åŠŸèƒ½ B: ä¸Šå‚³æ­·å²æª” ---
    const fileInput = document.getElementById('file-input');
    const btnUpload = document.getElementById('btn-upload');
    const statusUpload = document.getElementById('status-upload');
    let excelData = null;

    // 1. è®€å– Excel
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                excelData = workbook;
                btnUpload.disabled = false;
                btnUpload.innerText = `æº–å‚™ä¸Šå‚³ (å…± ${workbook.SheetNames.length} å€‹åˆ†é )`;
                showStatus(statusUpload, `å·²è®€å–æª”æ¡ˆï¼ŒåŒ…å«ä»¥ä¸‹åŸºé‡‘åˆ†é ï¼š\n${workbook.SheetNames.join(', ')}`, "loading");
            } catch (err) {
                showStatus(statusUpload, "âŒ æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯æœ‰æ•ˆçš„ Excel æª”ã€‚", "error");
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // 2. è§£æä¸¦ä¸Šå‚³
    btnUpload.addEventListener('click', async () => {
        if (!excelData) return;
        btnUpload.disabled = true;
        btnUpload.innerText = "â³ æ­£åœ¨è™•ç†è³‡æ–™ä¸¦ä¸Šå‚³...";
        
        try {
            let historyMap = new Map();
            let fundNames = [];

            // è§£ææ¯å€‹ Sheet
            excelData.SheetNames.forEach(sheetName => {
                const fundName = sheetName.trim();
                fundNames.push(fundName);
                const sheet = excelData.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (json.length < 2) return;

                for (let i = 1; i < json.length; i++) {
                    const row = json[i];
                    if (!row || row.length < 2) continue;
                    
                    let dVal = row[0], nVal = row[1];
                    if (dVal == null || nVal == null) continue;

                    // æ—¥æœŸæ¨™æº–åŒ–
                    let dateStr = "";
                    if (typeof dVal === 'number') {
                        const d = XLSX.SSF.parse_date_code(dVal);
                        dateStr = `${d.y}/${String(d.m).padStart(2,'0')}/${String(d.d).padStart(2,'0')}`;
                    } else {
                        dateStr = String(dVal).trim().replace(/-/g, '/');
                    }

                    if (!historyMap.has(dateStr)) historyMap.set(dateStr, { "æ—¥æœŸ": dateStr });
                    historyMap.get(dateStr)[fundName] = nVal;
                }
            });

            // è½‰æ›ç‚ºäºŒç¶­é™£åˆ—
            let headers = ["æ—¥æœŸ", ...fundNames];
            let sheetRows = [headers];
            let sortedDates = Array.from(historyMap.keys()).sort((a, b) => new Date(b) - new Date(a)); // æ–°åˆ°èˆŠ
            
            sortedDates.forEach(dateStr => {
                let rowObj = historyMap.get(dateStr);
                let row = [dateStr];
                for (let k = 1; k < headers.length; k++) {
                    row.push(rowObj[headers[k]] || "");
                }
                sheetRows.push(row);
            });

            showStatus(statusUpload, `æ­£åœ¨ä¸Šå‚³ ${sheetRows.length} ç­†æ•¸æ“šè‡³é›²ç«¯è³‡æ–™åº«...`, "loading");

            // POST
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    op: 'save_database',
                    data: sheetRows
                })
            });
            
            const json = await response.json();

            if (json.status === "success") {
                showStatus(statusUpload, "âœ… " + json.message + "\n(èˆŠè³‡æ–™å·²æˆåŠŸèˆ‡é›²ç«¯è³‡æ–™åº«åˆä½µ)", "success");
                btnUpload.innerText = "ä¸Šå‚³æˆåŠŸ";
            } else {
                throw new Error(json.message);
            }

        } catch (err) {
            console.error(err);
            showStatus(statusUpload, "âŒ ä¸Šå‚³å¤±æ•—: " + err.message, "error");
            btnUpload.innerText = "é‡è©¦";
            btnUpload.disabled = false;
        }
    });

    // è¼”åŠ©é¡¯ç¤ºå‡½å¼
    function showStatus(element, msg, type) {
        element.style.display = 'block';
        element.innerText = msg;
        element.className = 'status-box status-' + type;
    }
</script>

</body>
</html>
