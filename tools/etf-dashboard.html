<!doctype html>
<html lang="zh-Hant">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NG917BWVXP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-NG917BWVXP');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  
  <title>MOMO財商智庫｜ETF 績效戰情室</title>
  <link rel="icon" type="image/png" href="ETF.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet">

  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <style>
    :root {
      --deep: #050b14;
      --card-bg: rgba(17, 24, 39, 0.85);
      --gold: #FFD700;
      --gold-glow: rgba(255, 215, 0, 0.4);
      --silver: #E0E0E0;
      --bronze: #CD7F32;
      --text: #E5E7EB;
      --muted: #9CA3AF;
      --danger: #FF2A2A;
      --success: #00FF9D;
      --info: #00EAFF;
      --glass-border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body {
      margin: 0; background-color: var(--deep);
      background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px), radial-gradient(circle at 50% 0%, rgba(0, 234, 255, 0.1) 0%, transparent 60%);
      background-size: 40px 40px, 40px 40px, 100% 100%; background-attachment: fixed;
      font-family: "Noto Sans TC", sans-serif; color: var(--text); padding: 20px 10px;
    }

    header { text-align: center; margin-bottom: 30px; }

    /* 返回按鈕樣式 */
    .btn-home {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--gold);
      text-decoration: none;
      border: 1px solid var(--gold);
      font-weight: bold;
      font-size: 13px;
      transition: all 0.3s;
      margin-bottom: 20px;
      clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
    }
    .btn-home:hover {
      background: var(--gold);
      color: #000;
      box-shadow: 0 0 20px var(--gold-glow);
    }

    h1 { color: var(--gold); font-size: 26px; text-shadow: 0 0 15px var(--gold-glow); border-bottom: 3px solid var(--gold); padding-bottom: 8px; display: inline-block; margin: 10px 0; }
    .desc { color: var(--muted); font-size: 13px; max-width: 500px; margin: 5px auto; background: rgba(0,0,0,0.4); padding: 8px 15px; border-left: 3px solid var(--info); }

    /* Loading Effect */
    .loading-container { margin: 40px auto; max-width: 300px; text-align: center; }
    .loading-text { color: var(--info); font-size: 14px; margin-bottom: 12px; font-family: "Roboto Mono"; text-shadow: 0 0 8px var(--info); }
    
    /* 進度條背景與掃描特效 */
    .progress-bar-bg { 
      width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; 
      overflow: hidden; position: relative; box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .progress-bar-bg::after {
      content: ""; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 234, 255, 0.4), transparent);
      animation: scan 1.5s infinite;
    }
    @keyframes scan { 0% { left: -100%; } 100% { left: 100%; } }
    
    .progress-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00EAFF, #00FF9D); transition: width 0.1s linear; box-shadow: 0 0 10px var(--info); }

    /* Table & Medals */
    .table-container { background: var(--card-bg); backdrop-filter: blur(10px); border: var(--glass-border); border-radius: 12px; overflow: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
    table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 580px; } 
    thead { position: sticky; top: 0; z-index: 10; background: #0A1221; }
    th { padding: 12px 6px; font-size: 12px; color: var(--muted); border-bottom: 1px solid rgba(255,255,255,0.2); cursor: pointer; user-select: none; }
    th.sort-active { color: var(--gold); }
    td { padding: 12px 6px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; font-family: "Roboto Mono"; font-size: 13px; }
    
    .rank-medal { display: inline-block; width: 22px; height: 22px; line-height: 22px; border-radius: 50%; font-weight: bold; font-size: 11px; color: #000; }
    .rank-1 { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
    .rank-2 { background: var(--silver); box-shadow: 0 0 10px var(--silver); }
    .rank-3 { background: var(--bronze); box-shadow: 0 0 10px var(--bronze); }
    .rank-n { color: var(--muted); }

    .symbol-link { color: var(--gold); text-decoration: none; font-weight: bold; }
    .pos { color: var(--success); }
    .neg { color: var(--danger); }

    .split-hint {
      display: inline-block; margin-left: 4px; color: var(--info); font-weight: bold;
      cursor: help; text-decoration: underline dotted;
    }

    /* Modal */
    .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9998; backdrop-filter: blur(5px); }
    .modal-box { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 280px; background: #0A1221; border: 1px solid var(--info); padding: 20px; z-index: 9999; border-radius: 8px; }
    .show-modal { display: block; }
  </style>
</head>
<body>

<div class="page">
  <header>
    <a href="https://nms3194949.github.io/MOMO_FinSphere" class="btn-home">&lt; 返回首頁</a>
    <br>
    <h1>ETF 績效戰情室</h1>
    <div class="desc">數據更新至 2025.12 | 模式：還原權息演算</div>
  </header>

  <div id="loading-container" class="loading-container">
    <div id="loading-text" class="loading-text">連線數據中心... 0%</div>
    <div class="progress-bar-bg"><div id="progress-bar-fill" class="progress-bar-fill"></div></div>
  </div>

  <div class="table-container">
    <table id="etf-table" style="display:none;">
      <thead>
        <tr>
          <th style="width: 45px;">排名</th>
          <th data-sort="symbol">代碼</th>
          <th style="text-align:left;">名稱</th>
          <th>頻率</th>
          <th data-sort="total">年化總報酬</th>
          <th data-sort="yield1">殖利率(1Y)</th>
          <th data-sort="yann">年化配息率</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<div id="modal-backdrop" class="modal-backdrop" onclick="closeHelp()"></div>
<div id="modal-box" class="modal-box">
  <div id="modal-title" style="color:var(--info); font-weight:bold; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;"></div>
  <div id="modal-formula" style="color:var(--gold); font-family:'Roboto Mono'; font-size:11px; margin-bottom:10px;"></div>
  <div id="modal-desc" style="font-size:13px; line-height:1.5;"></div>
  <button style="width:100%; margin-top:15px; padding:10px; background:rgba(255,255,255,0.1); color:#fff; border:none; cursor:pointer;" onclick="closeHelp()">關閉視窗</button>
</div>

<script>
const WORKER_URL = "https://etf-metrics-worker.nms3194949.workers.dev/etf-metrics";
const YEARS = 3;

const ETF_META = {
  "0056": { name: "元大台灣高股息", freq: "季配" },
  "00713": { name: "元大高股息低波動", freq: "季配" },
  "00878": { name: "國泰永續高股息", freq: "季配" },
  "00918": { name: "大華優選高填息30", freq: "季配" },
  "00919": { name: "群益台灣精選高息", freq: "季配" },
  "00929": { name: "復華科技優息", freq: "月配" },
  "00940": { name: "元大台灣價值高息", freq: "月配" },
  "00915": { name: "凱基台灣優選高股息30", freq: "季配" },
  "0050": { name: "元大台灣50", freq: "半年配" },
  "0052": { 
      name: "富邦科技", 
      freq: "年配", 
      splitInfo: "拆分日期：2025/09/25\n說明：本基金執行「1拆7」分割案，數據已進行權值還原校正，殖利率基準符合最新現價。" 
  },
  "00881": { name: "國泰科技龍頭", freq: "半年配" },
  "00757": { name: "統一NYSE FANG+", freq: "不配息" }
};

const BATCHES = [
  ["0056","00713","00878","00918","00919","00929"],
  ["00940","00915","0050","0052","00881","00757"]
];

let dataRows = [];
let currentSort = ""; 
let isDesc = true;

// --- 進度條跳動動畫 ---
let displayProgress = 0;
let progressTarget = 0;
let currentStatusText = "全速演算中...";

function animateProgress() {
  if (displayProgress < progressTarget) {
    displayProgress += 0.8; 
    if (displayProgress > progressTarget) displayProgress = progressTarget;
    document.getElementById("loading-text").innerText = `${currentStatusText} ${Math.floor(displayProgress)}%`;
    document.getElementById("progress-bar-fill").style.width = `${displayProgress}%`;
  }
  if (displayProgress < 100) requestAnimationFrame(animateProgress);
}

function updateStatus(target, text) {
  progressTarget = target;
  if (text) currentStatusText = text;
}

function showHelp(t, f, d) {
  document.getElementById('modal-title').innerText = t;
  document.getElementById('modal-formula').innerText = "公式: " + f;
  document.getElementById('modal-desc').innerText = d;
  document.getElementById('modal-backdrop').classList.add('show-modal');
  document.getElementById('modal-box').classList.add('show-modal');
}
function closeHelp() {
  document.getElementById('modal-backdrop').classList.remove('show-modal');
  document.getElementById('modal-box').classList.remove('show-modal');
}

function getRankBadge(i) {
  if (i === 0) return `<span class="rank-medal rank-1">1</span>`;
  if (i === 1) return `<span class="rank-medal rank-2">2</span>`;
  if (i === 2) return `<span class="rank-medal rank-3">3</span>`;
  return `<span class="rank-medal rank-n">${i+1}</span>`;
}

function fixSplitLogic(row) {
    let r = { ...row };
    if (r.symbol === "0052" && r.price?.annualized_return_ex_div < -0.1) {
        const originalRatio = Math.pow(1 + r.price.annualized_return_ex_div, YEARS);
        r.price.annualized_return_ex_div = Math.pow(originalRatio * 7, 1 / YEARS) - 1;
    }
    return { data: r };
}

function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  dataRows.forEach((row, index) => {
    const { data: r } = fixSplitLogic(row);
    const meta = ETF_META[r.symbol] || { name: r.symbol, freq: "–" };
    
    const total = (r.price?.annualized_return_ex_div || 0) + (r.dividend?.yield_period_annualized || 0);
    let yield1 = r.dividend?.yield_1y || 0;
    let yann = r.dividend?.yield_period_annualized || 0;
    if (meta.freq === "不配息") { yield1 = 0; yann = 0; }

    const hintHTML = meta.splitInfo ? `<span class="split-hint" title="${meta.splitInfo}">(!)</span>` : "";

    tbody.innerHTML += `
    <tr>
      <td>${getRankBadge(index)}</td>
      <td><a href="https://tw.stock.yahoo.com/quote/${r.symbol}" target="_blank" class="symbol-link">${r.symbol}</a></td>
      <td style="text-align:left;">${meta.name}</td>
      <td style="color:var(--info); font-size:11px;">${meta.freq}</td>
      <td class="${total>=0?'pos':'neg'}" style="font-weight:bold;">
        ${(total*100).toFixed(2)}%${hintHTML}
      </td>
      <td class="${yield1>=0?'pos':'neg'}">
        ${(yield1*100).toFixed(2)}%${hintHTML}
      </td>
      <td class="${yann>=0?'pos':'neg'}">
        ${(yann*100).toFixed(2)}%
      </td>
    </tr>`;
  });
}

function sortBy(key, forceDesc = false){
  if (forceDesc) { currentSort = key; isDesc = true; }
  else if (currentSort === key) isDesc = !isDesc;
  else { currentSort = key; isDesc = true; }

  document.querySelectorAll('th[data-sort]').forEach(th => {
      th.classList.remove('sort-active');
      if(th.dataset.sort === key) th.classList.add('sort-active');
  });
  
  dataRows.sort((a,b)=>{
    const fa = fixSplitLogic(a).data, fb = fixSplitLogic(b).data;
    let av, bv;
    if(key==="total") {
      av = (fa.price?.annualized_return_ex_div||0) + (fa.dividend?.yield_period_annualized||0);
      bv = (fb.price?.annualized_return_ex_div||0) + (fb.dividend?.yield_period_annualized||0);
    } else { av = fa[key] || 0; bv = fb[key] || 0; }
    return isDesc ? bv - av : av - bv;
  });
  render();
}

async function load(){
  animateProgress(); 
  updateStatus(10, "正在連線...");
  try {
    const list = [];
    for(let i=0; i<BATCHES.length; i++){
      updateStatus(Math.round(((i + 1) / BATCHES.length) * 100), i === 0 ? "數據載入中..." : "演算排序中...");
      const r = await fetch(`${WORKER_URL}?symbols=${BATCHES[i].join(",")}&years=${YEARS}`);
      const j = await r.json();
      if(j.etfs) list.push(...j.etfs);
    }
    dataRows = list;
    setTimeout(() => {
      document.getElementById("loading-container").style.display="none";
      document.getElementById("etf-table").style.display="table";
      sortBy("total", true); 
    }, 600);
  } catch(e) { updateStatus(displayProgress, "❌ 連線失敗"); }
}

document.querySelectorAll("th[data-sort]").forEach(th => {
  th.addEventListener("click", () => sortBy(th.dataset.sort));
});

load();
</script>
</body>
</html>
